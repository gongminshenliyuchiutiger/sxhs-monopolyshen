<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼«éŠé›™æºªæ­¥ä½ˆèµ°è®€ç¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root {
            --square-size: clamp(75px, 10vw, 90px);
            --board-border-color: #2c7a51; /* Deep Green */
            --board-gap: 4px;
            --accent-color-1: #4CAF50; /* Vibrant Green */
            --accent-color-2: #FFC107; /* Amber Yellow */
            --text-dark: #333;
            --text-light: #f8f8f8;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #e0f2f1; /* Lighter teal base */
            background-image: linear-gradient(to bottom right, #e6f7e1, #d0f0c0), 
                              radial-gradient(rgba(136, 196, 154, 0.5) 1.2px, transparent 1.2px);
            background-size: cover, 28px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100vh;
            padding: 1rem;
            margin: 0;
            color: var(--text-dark);
        }

        .game-wrapper {
            max-width: 900px;
            width: 100%;
            background-color: rgba(240, 249, 232, 0.95); /* Slightly transparent light green */
            border-radius: 20px;
            box-shadow: 0 15px 45px rgba(0,0,0,0.22), 0 0 0 6px rgba(44, 122, 81, 0.35);
            padding: clamp(1.2rem, 3.5vw, 2rem);
            border: 4px solid var(--board-border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: auto;
        }
        
        #board-path-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--board-gap);
            justify-content: center;
            padding: var(--board-gap);
            background-color: rgba(176, 217, 177, 0.8); /* Softer green */
            border-radius: 12px;
            margin-bottom: 25px;
            position: relative;
            width: 100%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }

        .board-square {
            width: var(--square-size);
            height: var(--square-size);
            border: 2px solid var(--board-border-color);
            background-color: #ffffff;
            transition: all 0.3s ease-in-out, transform 0.2s ease; /* Added transform transition */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            overflow: hidden;
            position: relative;
            cursor: default;
            border-radius: 10px; /* Base rounding */
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        .board-square:hover:not(.highlight) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 5px 12px rgba(0,0,0,0.12);
        }
        
        .board-square.highlight {
            box-shadow: 0 0 20px 8px rgba(255, 215, 0, 0.9); /* Brighter, larger highlight */
            transform: scale(1.05); /* Slightly more pronounced */
            z-index: 10;
            border-color: var(--accent-color-2);
        }

        /* Special Square Styles */
        .square-chance { background-color: #e0f7fa !important; border: 3px dashed #00BCD4 !important; border-radius: 25px !important; }
        .square-chance .location-icon i { color: #0097A7; }

        .square-fate { background-color: #fff3e0 !important; border: 3px dotted #FF9800 !important; border-radius: 50% !important; /* Circular */ }
        .square-fate .location-icon i { color: #F57C00; }

        .square-rest { background-color: #fce4ec !important; border: 3px double #E91E63 !important; border-radius: 12px 38px !important; /* Asymmetric */ }
        .square-rest .location-icon i { color: #C2185B; }

        .square-end .location-icon i { color: #FFD700; } /* Gold for trophy */
        .square-end .location-text { font-weight: bold; color: #6a0dad; } /* Purple for end text */


        .square-fate .location-text, .square-chance .location-text {
             font-size: clamp(7px, 1.3vw, 9px);
        }
        
        #board-center {
            background-color: rgba(255, 255, 255, 0.97);
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: clamp(18px, 2.5vw, 25px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            width: 100%;
            max-width: 580px;
            border: 3px solid var(--board-border-color);
        }

        .player {
            width: clamp(18px, 2.5vw, 22px);
            height: clamp(18px, 2.5vw, 22px);
            border-radius: 50%;
            position: absolute;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Smooth movement with bounce */
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: clamp(9px, 1.5vw, 11px);
            border: 1.5px solid rgba(0,0,0,0.35);
        }
        
        .dice {
            width: clamp(55px, 7.5vw, 65px);
            height: clamp(55px, 7.5vw, 65px);
            border-radius: 10px;
            background-color: var(--accent-color-1);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(30px, 4.5vw, 38px);
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease-out;
        }
        
        .dice:hover { transform: translateY(-3px) scale(1.12); box-shadow: 0 7px 14px rgba(0,0,0,0.28); }
        .dice:active { transform: translateY(0px) scale(1.05); box-shadow: 0 3px 6px rgba(0,0,0,0.22); }
        .dice.rolling { animation: diceRoll 0.5s ease-in-out infinite; }
        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(20deg) scale(1.08); }
            75% { transform: rotate(-20deg) scale(1.08); }
            100% { transform: rotate(0deg) scale(1); }
        }
        
        .popup-card { /* Base for event and quiz cards */
            position: fixed;
            width: clamp(300px, 85vw, 400px);
            min-height: 180px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
            padding: 25px 30px;
            z-index: 200;
            top: 50%; left: 50%;
            border: 4px solid var(--accent-color-1);
            display: flex; /* Changed to flex for easier content management */
            flex-direction: column;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.85);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none;
        }
        .popup-card.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .quiz-options button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1.5px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 0.9rem;
        }
        .quiz-options button:hover { background-color: #eef; border-color: var(--accent-color-1); }
        .quiz-options button:disabled { background-color: #f0f0f0; color: #999; cursor: not-allowed; }
        
        .location-icon i { font-size: clamp(24px, 3.8vw, 30px); margin-bottom: 5px; color: #388E3C; }
        .location-text { font-size: clamp(8.5px, 1.6vw, 10.5px); font-weight: 500; line-height: 1.25; }
        
        .player-color-indicator { width: 16px; height: 16px; border-radius: 50%; display: inline-block; margin-right: 8px; border: 1px solid rgba(0,0,0,0.15); }
        .player-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; width: 100%; max-height: 170px; overflow-y: auto; padding: 8px; margin-bottom: 12px; background-color: rgba(220,240,220,0.5); border-radius: 8px;}
        .player-info-box { background-color: #e8f5e9; padding: 8px 10px; border-radius: 8px; font-size: clamp(11.5px, 1.9vw, 12.5px); border: 1.5px solid #c8e6c9; transition: all 0.3s ease; }
        .player-info-box.active { border: 2.5px solid var(--accent-color-1); box-shadow: 0 0 10px rgba(76, 175, 80, 0.5); transform: scale(1.03); background-color: #dff3df; }
        .game-message-area { background-color: #dcf4dc; padding: clamp(10px, 1.8vw, 12px); border-radius: 10px; width: 100%; text-align: center; margin-bottom: 12px; color: #1b5e20; border: 1.5px solid #a5d6a7; font-weight: 500; font-size: clamp(12.5px, 2.1vw, 14.5px); min-height: 45px; transition: opacity 0.2s ease-in-out; }
        
        .start-setup-area { width: 100%; margin-bottom: 15px; }
        .start-controls { display: flex; justify-content: space-between; align-items: center; width: 100%; font-size: clamp(12.5px, 2.1vw, 14.5px); padding: 0 8px; margin-bottom: 10px; }
        #player-name-setup { width: 100%; margin-top: 10px; }
        #player-name-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .player-name-entry { display: flex; align-items: center; gap: 8px; padding: 6px 8px; background-color: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;}
        .player-name-input { flex-grow: 1; border: 1px solid #ced4da; border-radius: 4px; padding: 4px 8px; font-size: 0.85rem; }
        .player-name-input:focus { border-color: var(--accent-color-1); box-shadow: 0 0 0 0.2rem rgba(76,175,80,.25); outline: none;}


        .action-button { /* Common style for start/close buttons */
            background-color: var(--accent-color-1);
            color: var(--text-light);
            padding: 8px 15px; /* Slightly larger */
            border-radius: 6px;
            font-size: 0.95rem; /* Slightly larger */
            transition: background-color 0.2s, transform 0.15s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border: none;
            cursor: pointer;
        }
        .action-button:hover { background-color: #388E3C; filter: brightness(110%); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .action-button:active { transform: translateY(0px); filter: brightness(95%); box-shadow: 0 1px 2px rgba(0,0,0,0.15) inset; }
        .action-button:disabled { background-color: #aaa; cursor: not-allowed; filter: grayscale(50%);}
        
        .footer {
            width: 100%;
            text-align: center;
            padding: 15px 0;
            font-size: 0.85rem;
            color: #444;
            margin-top: 30px;
            background-color: rgba(200, 230, 201, 0.6);
            border-top: 1px solid rgba(44, 122, 81, 0.25);
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-green-800 mb-5">æ¼«éŠé›™æºªæ­¥ä½ˆèµ°è®€ç¥</h1>
        
        <div id="board-path-container">
            <!-- Start -->
            <div class="board-square bg-green-100" data-type="start" data-location="é ‚é›™æºª">
                <div class="location-icon"><i class="fas fa-flag-checkered"></i></div><div class="location-text">é ‚é›™æºª</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="é›™æºªç«è»Šç«™">
                <div class="location-icon"><i class="fas fa-train-subway"></i></div><div class="location-text">é›™æºªç«è»Šç«™</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="é›™æºªé€é›¨å··">
                <div class="location-icon"><i class="fas fa-cloud-showers-heavy"></i></div><div class="location-text">é›™æºªé€é›¨å··</div>
            </div>
            <!-- Chance -->
            <div class="board-square square-chance" data-type="chance" data-location="å¹³æ—æºª">
                <div class="location-icon"><i class="fas fa-water"></i></div><div class="location-text">å¹³æ—æºª</div>
            </div>
             <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="é›™æºªæ‰“éµèˆ–">
                <div class="location-icon"><i class="fas fa-hammer"></i></div><div class="location-text">é›™æºªæ‰“éµèˆ–</div>
            </div>
            <!-- Rest -->
            <div class="board-square square-rest" data-type="rest" data-location="æµ·å±±é¤…åº—">
                <div class="location-icon"><i class="fas fa-cookie-bite"></i></div><div class="location-text">æµ·å±±é¤…åº—</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="ä¿æˆ‘é»æ°‘ç¢‘">
                <div class="location-icon"><i class="fas fa-monument"></i></div><div class="location-text">ä¿æˆ‘é»æ°‘ç¢‘</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="é›™æºªä¸‰å¿ å»Ÿ">
                <div class="location-icon"><i class="fas fa-landmark"></i></div><div class="location-text">é›™æºªä¸‰å¿ å»Ÿ</div>
            </div>
            <!-- Fate -->
            <div class="board-square square-fate" data-type="fate" data-location="æ¯›èŸ¹">
                <div class="location-icon"><i class="fas fa-paw"></i></div><div class="location-text">æ¯›èŸ¹</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="æ—ç›Šå’Œå ‚">
                <div class="location-icon"><i class="fas fa-store"></i></div><div class="location-text">æ—ç›Šå’Œå ‚</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="æ¸¡èˆ¹é ­">
                <div class="location-icon"><i class="fas fa-anchor"></i></div><div class="location-text">æ¸¡èˆ¹é ­</div>
            </div>
            <!-- Rest -->
            <div class="board-square square-rest" data-type="rest" data-location="è”¡å†°é›ªèŠ±å†°">
                <div class="location-icon"><i class="fas fa-ice-cream"></i></div><div class="location-text">è”¡å†°é›ªèŠ±å†°</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="å‘¨å®¶å¤å">
                <div class="location-icon"><i class="fas fa-house-chimney-user"></i></div><div class="location-text">å‘¨å®¶å¤å</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="é•·å®‰è€è¡—">
                <div class="location-icon"><i class="fas fa-road"></i></div><div class="location-text">é•·å®‰è€è¡—</div>
            </div>
            <!-- Fate -->
            <div class="board-square square-fate" data-type="fate" data-location="å±±è—¥">
                <div class="location-icon"><i class="fas fa-carrot"></i></div><div class="location-text">å±±è—¥</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="é€£èˆ‰äººå">
                <div class="location-icon"><i class="fas fa-landmark-dome"></i></div><div class="location-text">é€£èˆ‰äººå</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="è”´ç«¹å‘ç¦å¾·ç¥ ">
                <div class="location-icon"><i class="fas fa-place-of-worship"></i></div><div class="location-text">è”´ç«¹å‘ç¦å¾·ç¥ </div>
            </div>
             <!-- Chance -->
            <div class="board-square square-chance" data-type="chance" data-location="ç‰¡ä¸¹æºª">
                <div class="location-icon"><i class="fas fa-water"></i></div><div class="location-text">ç‰¡ä¸¹æºª</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="æ·¡è˜­å¤é“">
                <div class="location-icon"><i class="fas fa-hiking"></i></div><div class="location-text">æ·¡è˜­å¤é“</div>
            </div>
             <!-- Rest -->
            <div class="board-square square-rest" data-type="rest" data-location="æ¯›èŸ¹ç››">
                <div class="location-icon"><i class="fas fa-utensils"></i></div><div class="location-text">æ¯›èŸ¹ç››</div>
            </div>
            <!-- Fate -->
            <div class="board-square square-fate" data-type="fate" data-location="é‡è–‘èŠ±">
                <div class="location-icon"><i class="fas fa-fan"></i></div><div class="location-text">é‡è–‘èŠ±</div>
            </div>
            <!-- Attractions -->
            <div class="board-square" data-type="attraction" data-location="è™è±¹æ½­">
                <div class="location-icon"><i class="fas fa-swimmer"></i></div><div class="location-text">è™è±¹æ½­</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="ä¸å­äº­">
                <div class="location-icon"><i class="fas fa-binoculars"></i></div><div class="location-text">ä¸å­äº­</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="é›™æºªè·èŠ±åœ’">
                <div class="location-icon"><i class="fas fa-spa"></i></div><div class="location-text">é›™æºªè·èŠ±åœ’</div>
            </div>
            <!-- End -->
            <div class="board-square bg-purple-200 square-end" data-type="end" data-location="é›™æºªé«˜ä¸­">
                <div class="location-icon"><i class="fas fa-trophy"></i></div><div class="location-text">é›™æºªé«˜ä¸­</div>
            </div>
        </div> 
        
        <div id="board-center">
            <div class="text-xl md:text-2xl font-bold text-green-700 mb-3">éŠæˆ²æ§åˆ¶æ¿</div>
            <div class="dice mb-4" id="dice"><i class="fas fa-dice-d6"></i></div>
            
            <div class="start-setup-area">
                <div class="start-controls">
                    <div>
                        <label for="player-count" class="font-medium">äººæ•¸:</label>
                        <select id="player-count" class="border rounded px-1.5 py-1 text-sm shadow-sm">
                            <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <button id="start-game" class="action-button">é–‹å§‹éŠæˆ²</button>
                </div>
                <div id="player-name-setup" style="display: none;">
                     <h4 class="font-semibold mb-2 text-sm text-green-600">è¨­å®šç©å®¶åç¨± (é¸å¡«):</h4>
                     <div id="player-name-inputs"></div>
                </div>
            </div>
            
            <div class="flex justify-between items-center w-full mb-3">
                <div>
                    <span class="font-medium">è¼ªåˆ°: </span>
                    <span id="current-player-name-display" class="font-bold text-red-600 text-lg"></span>
                </div>
                <div>
                    <span class="font-medium">ç©å®¶ç·¨è™Ÿ: </span>
                    <span id="current-player-indicator" class="font-bold text-red-600 text-lg"></span>
                </div>
            </div>

            <div class="game-message-area" id="game-message">é¸æ“‡äººæ•¸ä¸¦é–‹å§‹éŠæˆ²ï¼</div>
            <div class="player-controls" id="player-controls"></div>
        </div>
        
        <!-- Event Card -->
        <div class="popup-card event-card" id="event-card">
            <h3 class="text-xl font-bold mb-3 text-green-700" id="event-title">äº‹ä»¶å¡</h3>
            <p id="event-description" class="mb-5 text-gray-700 text-base flex-grow">äº‹ä»¶æè¿°</p>
            <button id="event-close" class="action-button w-full py-2.5">ç¢ºå®š</button>
        </div>

        <!-- Quiz Card -->
        <div class="popup-card quiz-card" id="quiz-card">
            <h3 class="text-xl font-bold mb-3 text-blue-700" id="quiz-title">æ™¯é»å•ç­”</h3>
            <p id="quiz-question" class="mb-4 text-gray-800 text-base font-medium">å•é¡Œå…§å®¹...</p>
            <div id="quiz-options" class="quiz-options mb-4 flex-grow">
                <!-- Options will be generated here -->
            </div>
            <p id="quiz-feedback" class="text-base font-bold mb-4 h-6 text-center"></p>
            <!-- Submit button removed, answer by clicking option -->
        </div>
    </div>

    <div class="footer">
        Copyright Â© Liyuchiutiger Gongminshen
    </div>

    <script>
        const el = (id) => document.getElementById(id);
        const diceElement = el('dice'), gameMessageElement = el('game-message'), playerCountSelect = el('player-count');
        const startGameButton = el('start-game'), currentPlayerIndicator = el('current-player-indicator');
        const currentPlayerNameDisplay = el('current-player-name-display');
        const playerControlsContainer = el('player-controls'), eventCardElement = el('event-card');
        const eventTitleElement = el('event-title'), eventDescriptionElement = el('event-description');
        const eventCloseButton = el('event-close'), boardPathContainer = el('board-path-container');
        const quizCardElement = el('quiz-card'), quizTitleElement = el('quiz-title');
        const quizQuestionElement = el('quiz-question'), quizOptionsElement = el('quiz-options');
        const quizFeedbackElement = el('quiz-feedback');
        const playerNameSetupDiv = el('player-name-setup'), playerNameInputsDiv = el('player-name-inputs');

        const CHANCE_OF_DOUBLING = 0.33; // 33% chance for doubling effects

        const gameState = {
            currentPlayer: 1, players: {}, playerCount: 2, diceRolling: false, boardPath: [], 
            gameStarted: false, currentQuiz: null, endSquareIndex: -1,
            playerColors: ['#E53935', '#1E88E5', '#43A047', '#FDD835', '#8E24AA', '#FB8C00', '#00ACC1', '#D81B60', '#6D4C41', '#7CB342', '#5E35B1', '#039BE5'], // 12 Colors
            quizData: { 
                "é›™æºªç«è»Šç«™": { q: "å¾è‡ºåŒ—å‡ºç™¼é›™æºªç«è»Šç«™çš„ä¸Šä¸‹ç«™åˆ†åˆ¥æ˜¯ï¼Ÿ", o: ["ç‰¡ä¸¹/è²¢å¯®", "ç‘èŠ³/ååˆ†", "å¹³æºª/ä¸‰è²‚å¶º", "ä¾¯ç¡/ç¦éš†"], a: 0 },
                "é›™æºªé€é›¨å··": { q: "ã€Œé€é›¨å··ã€çš„åç¨±ç”±ä¾†èˆ‡ä¸‹åˆ—ä½•è€…æœ€ä¸ç›¸é—œï¼Ÿ", o: ["æ™‚å¸¸ä¸‹é›¨", "é¦¬å…’è¿½é€", "è©©è©èªå¥", "ç´°é•·å··å­"], a: 1 },
                "é›™æºªæ‰“éµèˆ–": { q: "é›™æºªæ‰“éµèˆ–ä»¥è£½ä½œä½•ç¨®å‚³çµ±å·¥å…·èåï¼Ÿ", o: ["è¾²å…·", "å…µå™¨", "é»ƒé‡‘é …éŠ", "ç´”éŠ€é£¾å“"], a: 0 },
                "ä¿æˆ‘é»æ°‘ç¢‘": { q: "ã€Œä¿æˆ‘é»æ°‘ã€ç¢‘ç«‹ç¢‘çš„æ­·å²èƒŒæ™¯èˆ‡ä¸‹åˆ—ä½•è€…æœ‰é—œï¼Ÿ", o: ["æ¢°é¬¥å¹³æ¯", "æ°´åˆ©å»ºè¨­", "å®˜æ–¹è¤’ç", "é–‹è·¯ç´€å¿µ"], a: 2 },
                "é›™æºªä¸‰å¿ å»Ÿ": { q: "é›™æºªä¸‰å¿ å»Ÿä¸»è¦ä¾›å¥‰å“ªä¸‰ä½å®‹ä»£å¿ è‡£ï¼Ÿ", o: ["å²³é£›ã€é—œç¾½ã€å¼µé£›", "æ–‡å¤©ç¥¥ã€é™¸ç§€å¤«ã€å¼µä¸–å‚‘", "è«¸è‘›äº®ã€åŠ‰å‚™ã€é—œç¾½", "å±ˆåŸã€ä¼å­èƒ¥ã€æ¯”å¹²"], a: 1 },
                "æ—ç›Šå’Œå ‚": { q: "æ—ç›Šå’Œå ‚éå»æ˜¯é›™æºªåœ°å€é‡è¦çš„ä½•ç¨®åº—èˆ–ï¼Ÿ", o: ["ä¸­è—¥é‹ª", "å¸ƒèŠ", "ç±³è¡Œ", "é›œè²¨åº—"], a: 0 },
                "æ¸¡èˆ¹é ­": { q: "é›™æºªçš„æ¸¡èˆ¹é ­ä¸»è¦ä½æ–¼å“ªå…©æ¢æºªçš„åŒ¯æµè™•é™„è¿‘ï¼Ÿ", o: ["åŸºéš†æ²³ã€å¤§æ¼¢æºª", "å¹³æ—æºªã€ç‰¡ä¸¹æºª", "æ–°åº—æºªã€æ™¯ç¾æºª", "å†¬å±±æ²³ã€è˜­é™½æºª"], a: 1 },
                "å‘¨å®¶å¤å": { q: "é—œæ–¼é›™æºªåœ°å€å‘¨å®¶å¤åå’Œè€…æ•˜è¿°æ­£ç¢ºï¼Ÿ", o: ["å»ºæåŒ…å«ç ‚å²©ç´…ç£š", "å‘¨æ°å€«çš„æˆ¿ç”¢", "äº”å±¤æ¨“å»ºç¯‰", "å¸Œè‡˜å¼é¢¨æ ¼å»ºç¯‰"], a: 0 },
                "é•·å®‰è€è¡—": { q: "é›™æºªé•·å®‰è€è¡—éå»å› ä½•ç¨®ç”¢æ¥­è€Œç¹æ¦®ï¼Ÿ", o: ["ç¤¦æ¥­", "èŒ¶è‘‰", "æ¨Ÿè…¦", "æ¼æ¥­"], a: 0 },
                "é€£èˆ‰äººå": { q: "é€£èˆ‰äººåæ­£å»³é–€ä¸Šæ‡¸æ›çš„åŒ¾é¡æ˜¯ï¼Ÿ", o: ["æ–‡é­", "æ–‡é’", "æ–‡æ‰", "æ–‡èˆ‰"], a: 0 },
                "è”´ç«¹å‘ç¦å¾·ç¥ ": { q: "ç¦å¾·ç¥ ä¸»è¦ä¾›å¥‰çš„ç¥ç¥‡æ˜¯ï¼Ÿ", o: ["åª½ç¥–", "åœŸåœ°å…¬", "é—œå…¬", "è§€éŸ³è©è–©"], a: 1 },
                "æ·¡è˜­å¤é“": { q: "æ·¡è˜­å¤é“æ˜¯æ—©æœŸé€£æ¥è‡ºç£ä½•è™•çš„é‡è¦è·¯å¾‘ï¼Ÿ", o: ["æ·¡æ°´èˆ‡è˜­é™½å¹³åŸ", "å°åŒ—èˆ‡å°ä¸­", "å°å—èˆ‡é«˜é›„", "èŠ±è“®èˆ‡å°æ±"], a: 0 },
                "è™è±¹æ½­": { q: "è™è±¹æ½­åç¨±çš„ç”±ä¾†ï¼Œæ“šèªªèˆ‡æ½­é‚Šçš„ä»€éº¼æœ‰é—œï¼Ÿ", o: ["å‹•ç‰©å½¢ç‹€çš„å²©çŸ³", "æ›¾æœ‰è™è±¹å‡ºæ²’", "æ°´æµè²ä¼¼è™è±¹", "ç•¶åœ°éƒ¨è½åœ–é¨°"], a: 0 },
                "ä¸å­äº­": { q: "ä¸å­äº­ä½æ–¼æ–°åŒ—å¸‚é›™æºªå€èˆ‡ä¹ä»½äº¤ç•Œï¼Œä»¥ä½•ç¨®æ™¯è§€èåï¼Ÿ", o: ["æµ·æ™¯", "å±±æ™¯å…¬è·¯", "å¤œæ™¯", "æ¹–æ™¯"], a: 1 },
                "é›™æºªè·èŠ±åœ’": { q: "é›™æºªè·èŠ±åœ’çš„æœ€ä½³è³èŠ±å­£ç¯€é€šå¸¸æ˜¯ï¼Ÿ", o: ["æ˜¥å­£", "å¤å­£", "ç§‹å­£", "å†¬å­£"], a: 1 },
            }
        };
        const DICE_ICONS = ["fa-dice-d6", "fa-dice-one", "fa-dice-two", "fa-dice-three", "fa-dice-four", "fa-dice-five", "fa-dice-six"];
        let audioCtx; // For Web Audio API

        function getAudioContext() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser");
                    return null;
                }
            }
            return audioCtx;
        }

        function playSound(type) {
            const ctx = getAudioContext();
            if (!ctx) return;

            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            gainNode.gain.setValueAtTime(0.1, ctx.currentTime); // Volume

            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
                oscillator.frequency.linearRampToValueAtTime(783.99, ctx.currentTime + 0.15); // G5
                gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.4);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.4);
            } else if (type === 'incorrect') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(349.23, ctx.currentTime); // F4
                oscillator.frequency.linearRampToValueAtTime(261.63, ctx.currentTime + 0.2); // C4
                gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
            }
        }


        const updateGameMessage = (message) => {
            gameMessageElement.style.opacity = '0';
            setTimeout(() => {
                gameMessageElement.textContent = message;
                gameMessageElement.style.opacity = '1';
            }, 150);
        };

        const initBoardPath = () => {
            gameState.boardPath = [];
            const squareElements = boardPathContainer.querySelectorAll('.board-square');
            squareElements.forEach((el, index) => {
                const locationData = { 
                    element: el, 
                    name: el.dataset.location, 
                    type: el.dataset.type 
                };
                gameState.boardPath.push(locationData);
                if (locationData.type === 'end') {
                    gameState.endSquareIndex = index;
                }
            });
        };
        
        const setupNameInputsUI = (count) => {
            playerNameInputsDiv.innerHTML = '';
            if (count > 0) {
                for (let i = 1; i <= count; i++) {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'player-name-entry';

                    const colorIndicator = document.createElement('span');
                    colorIndicator.className = 'player-color-indicator inline-block w-4 h-4 rounded-full shrink-0';
                    colorIndicator.style.backgroundColor = gameState.playerColors[(i - 1) % gameState.playerColors.length];
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `player-name-input-${i}`;
                    input.placeholder = `ç©å®¶ ${i} åç¨±`;
                    input.className = 'player-name-input';
                    
                    entryDiv.appendChild(colorIndicator);
                    entryDiv.appendChild(input);
                    playerNameInputsDiv.appendChild(entryDiv);
                }
                playerNameSetupDiv.style.display = 'block';
            } else {
                playerNameSetupDiv.style.display = 'none';
            }
        };

        const initPlayers = (count) => {
            document.querySelectorAll('.player').forEach(p => p.remove());
            playerControlsContainer.innerHTML = '';
            gameState.players = {};
            for (let i = 1; i <= count; i++) {
                const nameInput = el(`player-name-input-${i}`);
                const playerName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : `ç©å®¶ ${i}`;

                const playerToken = document.createElement('div');
                playerToken.id = `player${i}-token`;
                playerToken.className = 'player';
                playerToken.style.backgroundColor = gameState.playerColors[(i-1) % gameState.playerColors.length];
                playerToken.textContent = i;
                boardPathContainer.appendChild(playerToken);
                
                const playerInfoBox = document.createElement('div');
                playerInfoBox.id = `player${i}-infobox`;
                playerInfoBox.className = 'player-info-box';
                playerInfoBox.innerHTML = `<div class="flex items-center mb-0.5"><div class="player-color-indicator" style="background-color: ${gameState.playerColors[(i-1) % gameState.playerColors.length]}"></div><div class="font-bold">${playerName}</div></div><div>é‡‘å¹£: <span id="player${i}-money">1000</span></div>`;
                playerControlsContainer.appendChild(playerInfoBox);

                gameState.players[i] = { 
                    id: i, name: playerName, position: 0, money: 1000, 
                    color: gameState.playerColors[(i-1) % gameState.playerColors.length],
                    tokenElement: playerToken, infoBoxElement: playerInfoBox
                };
            }
            positionPlayers();
            updateAllMoneyDisplays();
        };

        const positionPlayers = () => {
            const squareCssSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--square-size').replace('px',''));
            const tokenCssSize = clamp(18, 0.025 * window.innerWidth, 22); // From CSS
            Object.values(gameState.players).forEach((playerData) => {
                const playerToken = playerData.tokenElement;
                const squareData = gameState.boardPath[playerData.position];
                if (!playerToken || !squareData || !squareData.element) return;

                const squareElement = squareData.element;
                const playersOnThisSquare = Object.values(gameState.players).filter(p => p.position === playerData.position);
                const playerIndexOnSquare = playersOnThisSquare.findIndex(p => p.tokenElement === playerToken);
                
                const itemsPerRow = Math.min(2, Math.ceil(Math.sqrt(playersOnThisSquare.length)));
                const col = playerIndexOnSquare % itemsPerRow;
                const row = Math.floor(playerIndexOnSquare / itemsPerRow);
                const gap = 3; 
                
                const totalWidthTakenByTokens = itemsPerRow * tokenCssSize + (itemsPerRow - 1) * gap;
                const baseOffsetX = (squareElement.offsetWidth - totalWidthTakenByTokens) / 2;
                const totalHeightTakenByTokens = Math.ceil(playersOnThisSquare.length / itemsPerRow) * tokenCssSize + (Math.ceil(playersOnThisSquare.length / itemsPerRow)-1)*gap;
                const baseOffsetY = (squareElement.offsetHeight - totalHeightTakenByTokens) / 2 + 5; 

                playerToken.style.top = `${squareElement.offsetTop + baseOffsetY + (row * (tokenCssSize + gap))}px`;
                playerToken.style.left = `${squareElement.offsetLeft + baseOffsetX + (col * (tokenCssSize + gap))}px`;
            });
        };
        function clamp(value, min, max) { return Math.min(Math.max(value, min), max); }

        const updatePlayerMoneyDisplay = (playerId) => {
            const moneyElement = el(`player${playerId}-money`);
            if (moneyElement && gameState.players[playerId]) moneyElement.textContent = gameState.players[playerId].money;
        };
        const updateAllMoneyDisplays = () => Object.keys(gameState.players).forEach(pId => updatePlayerMoneyDisplay(parseInt(pId)));

        const highlightCurrentPlayerInfoBox = () => {
            Object.values(gameState.players).forEach(player => player.infoBoxElement.classList.remove('active'));
            if (gameState.players[gameState.currentPlayer]) {
                 gameState.players[gameState.currentPlayer].infoBoxElement.classList.add('active');
            }
        };

        const rollDice = async () => {
            if (gameState.diceRolling || !gameState.gameStarted) return;
            gameState.diceRolling = true;
            diceElement.classList.add('rolling');
            diceElement.innerHTML = `<i class="fas fa-dice fa-spin"></i>`;
            
            const player = gameState.players[gameState.currentPlayer];
            updateGameMessage(`${player.name} æ­£åœ¨æ“²éª°å­...`);
            gameState.boardPath.forEach(pos => pos.element?.classList.remove('highlight'));

            await new Promise(resolve => setTimeout(resolve, 1200)); 

            const roll = Math.floor(Math.random() * 6) + 1;
            diceElement.classList.remove('rolling');
            diceElement.innerHTML = `<i class="fas ${DICE_ICONS[roll]}"></i>`;
            updateGameMessage(`${player.name} æ“²å‡º ${roll}é»...`);
            
            const startPosition = player.position;
            let hasWon = false;

            for (let i = 1; i <= roll; i++) {
                let currentStepPos = startPosition + i;
                if (currentStepPos >= gameState.endSquareIndex) {
                    player.position = gameState.endSquareIndex;
                    hasWon = true;
                } else {
                    player.position = currentStepPos % gameState.boardPath.length; 
                }
                positionPlayers();
                if (hasWon) {
                    await new Promise(resolve => setTimeout(resolve, 300)); // Short delay for final step to end
                    break; 
                }
                await new Promise(resolve => setTimeout(resolve, 250)); 
            }
            
            const landedSquareData = gameState.boardPath[player.position];
            landedSquareData.element?.classList.add('highlight');

            if (hasWon) {
                handleWin();
            } else {
                updateGameMessage(`${player.name} æŠµé” ${landedSquareData.name}`);
                setTimeout(() => handleSquareAction(landedSquareData), 800);
            }
        };
        
        function handleWin() {
            const player = gameState.players[gameState.currentPlayer];
            const endSquareData = gameState.boardPath[gameState.endSquareIndex];
            player.money += 300; // Winner's bonus (as per original end square logic)
            updatePlayerMoneyDisplay(gameState.currentPlayer);
            updateGameMessage(`ğŸ‰ ${player.name} æŠµé”çµ‚é» ${endSquareData.name} ä¸¦ç²å‹ï¼ğŸ‰`);

            diceElement.style.pointerEvents = 'none'; // Disable further rolls
            diceElement.innerHTML = `<i class="fas fa-trophy"></i>`;
            gameState.gameStarted = false; 

            showEventCardWithCustomMessage(
                `ğŸ‰ æ­å–œ ${player.name}ï¼ ğŸ‰`,
                `ä½ å·²æˆåŠŸæŠµé” ${endSquareData.name}ï¼Œæˆç‚ºé›™æºªæ­¥ä½ˆèµ°è®€ç¥ï¼ç²å¾— 300 é‡‘å¹£çå‹µï¼éŠæˆ²çµæŸã€‚`
            );
        }
        
        function handleSquareAction(squareData) {
            if (!gameState.gameStarted && squareData.type !== 'end') return; // Prevent actions if game ended by win but somehow this is called

            switch(squareData.type) {
                case 'chance': case 'fate':
                    showEvent(squareData.type); break;
                case 'rest': case 'start':
                    showRestEvent(squareData.name, squareData.type); break;
                case 'attraction':
                    showQuiz(squareData.name); break;
                case 'end': // Should be caught by handleWin in rollDice, but as a fallback.
                    handleWin();
                    break;
                default:
                    setTimeout(nextPlayerTurn, 700); 
            }
        }
        
        function showEventCardWithCustomMessage(title, description) {
            eventTitleElement.textContent = title;
            eventDescriptionElement.textContent = description;
            showPopup(eventCardElement);
            // The eventCloseButton will call nextPlayerTurn, which handles game end state
        }

        const nextPlayerTurn = () => {
            const previousPlayer = gameState.players[gameState.currentPlayer];
            if (previousPlayer && gameState.boardPath[previousPlayer.position]) {
                 gameState.boardPath[previousPlayer.position].element?.classList.remove('highlight');
            }

            if (!gameState.gameStarted) { // Game has ended or not yet started
                updateGameMessage('éŠæˆ²çµæŸï¼è«‹é¸æ“‡äººæ•¸ä¸¦é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€é‡æ–°é–‹å§‹ã€‚');
                startGameButton.disabled = false;
                playerCountSelect.disabled = false;
                playerNameSetupDiv.style.display = 'block'; // Show name inputs for new game
                // Clear name inputs
                playerNameInputsDiv.querySelectorAll('input').forEach(input => input.value = '');
                diceElement.innerHTML = `<i class="fas fa-dice-d6"></i>`;
                diceElement.style.pointerEvents = 'auto';
                currentPlayerIndicator.textContent = "-";
                currentPlayerNameDisplay.textContent = "ç­‰å¾…é–‹å§‹";
                return;
            }

            gameState.currentPlayer = (gameState.currentPlayer % gameState.playerCount) + 1;
            const currentPlayerData = gameState.players[gameState.currentPlayer];
            currentPlayerIndicator.textContent = currentPlayerData.id;
            currentPlayerNameDisplay.textContent = currentPlayerData.name;

            updateGameMessage(`è¼ªåˆ° ${currentPlayerData.name} çš„å›åˆ`);
            gameState.diceRolling = false;
            diceElement.innerHTML = `<i class="fas fa-dice-d6"></i>`;
            highlightCurrentPlayerInfoBox();

            const currentPlayerSquare = gameState.boardPath[currentPlayerData.position];
            if (currentPlayerSquare && currentPlayerSquare.element) {
                currentPlayerSquare.element.classList.add('highlight');
            }
        };
        
        const showPopup = (element) => {
            element.style.display = 'flex'; 
            setTimeout(() => element.classList.add('visible'), 10);
        };

        const hidePopup = (element, callback) => {
            element.classList.remove('visible');
            setTimeout(() => {
                element.style.display = 'none';
                if (callback) callback();
            }, 300); 
        };

        const showEvent = (type) => {
            let events, titlePrefix;
            const isDoubled = Math.random() < CHANCE_OF_DOUBLING; 

            if (type === 'chance') { 
                titlePrefix = "æ©Ÿæœƒ";
                events = [ { title: 'å¹³æ—æºªé‡£é­šæ¨‚', d: 'é‡£åˆ°å¤§é­šï¼Œç² # é‡‘å¹£', m: 200 }, { title: 'æ·¨æºªæ´»å‹•çå‹µ', d: 'åƒåŠ æ·¨æºªï¼Œç²ç’°ä¿ç # é‡‘å¹£', m: 150 }, { title: 'ç‰¡ä¸¹æºªç•”å¥½å¿ƒæƒ…', d: 'è¸é’æ„‰å¿«ï¼Œç² # é‡‘å¹£', m: 100 }, { title: 'æºªæ°´çªæ¼²æå¤±', d: 'è£å‚™è¢«æ²–èµ°ï¼Œæ # é‡‘å¹£', m: -120 }, { title: 'éºå¤±éŒ¢åŒ…', d: 'éŠç©ä¸æ…éºå¤±éŒ¢åŒ…ï¼Œæ # é‡‘å¹£', m: -80 }, { title: 'ç™¼ç¾ç§˜å¢ƒæ‰“å¡', d: 'æ‹ç…§æ‰“å¡ç²ç¤¾ç¾¤ç # é‡‘å¹£', m: 180 }];
            } else { // fate
                titlePrefix = "å‘½é‹";
                events = [ { title: 'æ¯›èŸ¹å¤§è±æ”¶', d: 'æ¯›èŸ¹è±æ”¶ï¼Œè²©å”®ç²åˆ© # é‡‘å¹£', m: 250 }, { title: 'å±±è—¥ç”°å¹«æ‰‹é…¬å‹', d: 'å”åŠ©æ”¶æˆå±±è—¥ï¼Œç²å ±é…¬ # é‡‘å¹£', m: 180 }, { title: 'é‡è–‘èŠ±å­£ä»£è¨€', d: 'æ“”ä»»æ¨å»£å¤§ä½¿ï¼Œç²ä»£è¨€è²» # é‡‘å¹£', m: 120 }, { title: 'é¢±é¢¨è¾²æä¿®ç¹•', d: 'é¢±é¢¨é€ æˆè¾²æï¼Œæ”¯ä»˜ä¿®ç¹•è²» # é‡‘å¹£', m: -150 }, { title: 'ç‰¹ç”¢è¡ŒéŠ·æˆåŠŸç', d: 'æˆåŠŸè¡ŒéŠ·ç‰¹ç”¢ï¼Œç²çé‡‘ # é‡‘å¹£', m: 200 }, { title: 'è¾²å…·æå£ç¶­ä¿®', d: 'è¾²å…·æå£ï¼Œä¿®ç†èŠ±è²» # é‡‘å¹£', m: -100 }];
            }
            const randomEvent = {...events[Math.floor(Math.random() * events.length)]}; // Shallow copy
            let actualMoney = randomEvent.m;
            let titleSuffix = "";

            if (isDoubled && randomEvent.m !== 0) { 
                actualMoney *= 2; 
                titleSuffix = " (é›™å€æ•ˆæœ!)"; 
            }
            
            randomEvent.d = randomEvent.d.replace('#', Math.abs(actualMoney));
            eventTitleElement.textContent = `${titlePrefix}: ${randomEvent.title}${titleSuffix}`;
            eventDescriptionElement.textContent = randomEvent.d;
            
            const player = gameState.players[gameState.currentPlayer];
            player.money += actualMoney;
            updatePlayerMoneyDisplay(gameState.currentPlayer);
            // Append to existing message from rollDice
            let currentMsg = gameMessageElement.textContent;
            currentMsg += ` ${actualMoney >= 0 ? 'ç²å¾—' : 'æå¤±'} ${Math.abs(actualMoney)} é‡‘å¹£ã€‚`;
            updateGameMessage(currentMsg);


            showPopup(eventCardElement);
        };

        const showRestEvent = (locationName, type) => {
            // Start square pass-through, handled by not doing anything special after first turn.
            if (type === 'start' && gameState.players[gameState.currentPlayer].position === 0 && 
                Object.values(gameState.players).some(p => p.position > 0 || Object.keys(gameState.players).length === 0)) {
                // If it's not the absolute first move of the game for anyone, and player lands on start
                updateGameMessage(`${gameState.players[gameState.currentPlayer].name} å›åˆ°èµ·é»ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚`);
                // No special money change for passing start, unless specified.
                showEventCardWithCustomMessage("å›åˆ°èµ·é»", `${locationName} - ç¨ä½œåœç•™ï¼Œé¤Šç²¾è“„éŠ³ã€‚`);
                return;
            }

            let eventData = { title: `${locationName} ä¼‘æ¯ä¸€ä¸‹`, description: `åœ¨ ${locationName} ç¨ä½œåœç•™ï¼Œé¤Šç²¾è“„éŠ³ã€‚`, money: 0 };
            let baseMoney = 0;
            let isMoneyRest = false;

            if (locationName === 'æµ·å±±é¤…åº—') { baseMoney = 100; eventData.title = 'æµ·å±±é¤…åº—å°æ†©'; eventData.description = 'å“åšé¦™æ¿ƒå¯’å¤©å¸ƒä¸è›‹ç³•ï¼Œæ¢å¾©å…ƒæ°£ï¼Œç² # é‡‘å¹£ã€‚'; isMoneyRest = true;}
            else if (locationName === 'è”¡å†°é›ªèŠ±å†°') { baseMoney = 120; eventData.title = 'è”¡å†°é›ªèŠ±å†°é€å¿ƒæ¶¼'; eventData.description = 'äº«ç”¨ç¾å‘³èŠ±ç”Ÿé›ªèŠ±å†°ï¼Œæš‘æ°£å…¨æ¶ˆï¼Œç² # é‡‘å¹£ã€‚'; isMoneyRest = true;}
            else if (locationName === 'æ¯›èŸ¹ç››') { baseMoney = 150; eventData.title = 'æ¯›èŸ¹ç››å®´'; eventData.description = 'å“åšè‚¥ç¾æ¯›èŸ¹ï¼Œç²¾åŠ›å……æ²›ï¼Œç² # é‡‘å¹£ã€‚'; isMoneyRest = true;}
            
            let actualMoney = baseMoney;
            let titleSuffix = "";
            if (isMoneyRest && Math.random() < CHANCE_OF_DOUBLING) {
                actualMoney *= 2;
                titleSuffix = " (é›™å€çå‹µ!)";
            }
            eventData.money = actualMoney;
            eventData.description = eventData.description.replace('#', actualMoney);
            
            eventTitleElement.textContent = eventData.title + titleSuffix;
            eventDescriptionElement.textContent = eventData.description;

            if (eventData.money > 0) { 
                gameState.players[gameState.currentPlayer].money += eventData.money; 
                updatePlayerMoneyDisplay(gameState.currentPlayer);
                 // Append to existing message
                let currentMsg = gameMessageElement.textContent;
                currentMsg += ` ç²å¾— ${eventData.money} é‡‘å¹£ã€‚`;
                updateGameMessage(currentMsg);
            }
            showPopup(eventCardElement);
        };

        const showQuiz = (locationName) => {
            const quiz = gameState.quizData[locationName];
            if (!quiz) { console.warn("No quiz for: " + locationName); nextPlayerTurn(); return; }
            gameState.currentQuiz = { ...quiz, location: locationName }; // Shallow copy
            quizTitleElement.textContent = `${locationName} å•ç­”`;
            quizQuestionElement.textContent = quiz.q;
            quizOptionsElement.innerHTML = '';
            quiz.o.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.textContent = `${String.fromCharCode(65 + index)}. ${optionText}`;
                button.dataset.index = index;
                button.addEventListener('click', handleQuizAnswer);
                quizOptionsElement.appendChild(button);
            });
            quizFeedbackElement.textContent = '';
            quizFeedbackElement.style.color = ''; 
            showPopup(quizCardElement);
        };

        function handleQuizAnswer(event) {
            const selectedIndex = parseInt(event.target.dataset.index);
            const quiz = gameState.currentQuiz;
            const player = gameState.players[gameState.currentPlayer];
            let feedback = "";
            let moneyChange = 0;

            if (selectedIndex === quiz.a) {
                playSound('correct');
                feedback = "ç­”å°äº†ï¼çœŸå²å®³ï¼ç²å¾— 50 é‡‘å¹£ï¼";
                moneyChange = 50;
                quizFeedbackElement.style.color = 'green';
            } else {
                playSound('incorrect');
                feedback = `ç­”éŒ¯äº†ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ ${String.fromCharCode(65 + quiz.a)}. æå¤± 20 é‡‘å¹£ã€‚`;
                moneyChange = -20;
                quizFeedbackElement.style.color = 'red';
            }
            player.money += moneyChange;
            updatePlayerMoneyDisplay(gameState.currentPlayer);
            quizFeedbackElement.textContent = feedback;
            
            quizOptionsElement.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                hidePopup(quizCardElement, nextPlayerTurn);
            }, 2200);
        }

        // Event Listeners
        playerCountSelect.addEventListener('change', () => {
            setupNameInputsUI(parseInt(playerCountSelect.value));
        });

        startGameButton.addEventListener('click', () => {
            gameState.playerCount = parseInt(playerCountSelect.value);
            if (gameState.playerCount < 1) {
                updateGameMessage("è«‹é¸æ“‡è‡³å°‘ä¸€ä½ç©å®¶ï¼");
                return;
            }
            initPlayers(gameState.playerCount);
            gameState.gameStarted = true;
            gameState.currentPlayer = 1; // Start with player 1
            
            const firstPlayer = gameState.players[1];
            currentPlayerIndicator.textContent = firstPlayer.id;
            currentPlayerNameDisplay.textContent = firstPlayer.name;
            
            updateGameMessage(`éŠæˆ²é–‹å§‹ï¼è¼ªåˆ° ${firstPlayer.name}`);
            diceElement.innerHTML = `<i class="fas fa-dice-d6"></i>`;
            diceElement.style.pointerEvents = 'auto';
            highlightCurrentPlayerInfoBox();
            
            gameState.boardPath.forEach(pos => pos.element?.classList.remove('highlight'));
            gameState.boardPath[0]?.element?.classList.add('highlight'); // Highlight start
            
            playerCountSelect.disabled = true; 
            startGameButton.disabled = true;
            playerNameSetupDiv.style.display = 'none'; // Hide name inputs during game
        });

        diceElement.addEventListener('click', rollDice);
        
        eventCloseButton.addEventListener('click', () => {
            hidePopup(eventCardElement, nextPlayerTurn);
        });

        document.addEventListener('DOMContentLoaded', () => {
            initBoardPath(); 
            playerCountSelect.value = "2"; // Default player count
            setupNameInputsUI(2); // Setup inputs for default count
            currentPlayerIndicator.textContent = "-";
            currentPlayerNameDisplay.textContent = "ç­‰å¾…é–‹å§‹";
            updateGameMessage('é¸æ“‡äººæ•¸ï¼Œè¼¸å…¥åç¨±(é¸å¡«)ï¼Œä¸¦é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€ï¼');
            // Ensure dice is clickable if game is not started (it is by default)
            diceElement.style.pointerEvents = 'auto';
        });
        window.addEventListener('resize', () => { if (gameState.gameStarted || Object.keys(gameState.players).length > 0) positionPlayers(); });
    </script>
</body>
</html>