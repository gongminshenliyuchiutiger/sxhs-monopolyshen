<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漫遊雙溪步佈走讀神</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        :root {
            --square-size: clamp(75px, 10vw, 90px);
            --board-border-color: #2c7a51; 
            --board-border-color-rgb: 44, 122, 81;
            --board-gap: 4px;
            --accent-color-1: #4CAF50; 
            --accent-color-1-rgb: 76,175,80;
            --accent-color-2: #FFC107; 
            --accent-color-2-rgb: 255,193,7;
            --text-dark: #333;
            --text-light: #f8f8f8;

            /* Light Mode Defaults */
            --bg-primary: #e0f2f1;
            --bg-gradient-start: #e6f7e1;
            --bg-gradient-end: #d0f0c0;
            --bg-radial-dot: rgba(136, 196, 154, 0.5);
            --game-wrapper-bg: rgba(240, 249, 232, 0.95);
            --game-wrapper-shadow: 0 15px 45px rgba(0,0,0,0.22), 0 0 0 6px rgba(44, 122, 81, 0.35);
            --board-path-bg: rgba(176, 217, 177, 0.8);
            --board-path-bg-rgb: 176, 217, 177;
            --board-square-bg: #ffffff;
            --board-square-shadow: 0 2px 5px rgba(0,0,0,0.08);
            --board-center-bg: rgba(255, 255, 255, 0.97);
            --board-center-shadow: 0 8px 20px rgba(0,0,0,0.12);
            --popup-bg: white;
            --popup-text-color: #333;
            --input-bg: #f8f9fa;
            --input-border: #dee2e6;
            --input-focus-border: var(--accent-color-1);
            --player-info-box-bg: #e8f5e9;
            --player-info-box-border: #c8e6c9;
            --player-info-box-active-bg: #dff3df;
            --game-message-bg: #dcf4dc; 
            --game-message-bg-rgb: 220, 244, 220;
            --game-message-border: #a5d6a7;
            --game-message-text: #1b5e20;
            --footer-bg: rgba(200, 230, 201, 0.6);
            --footer-border-top: rgba(44, 122, 81, 0.25);
            --footer-text: #444;
            --text-heading-color: #166534; 
            --text-subheading-color: #15803d;
            --text-quiz-title-color: #1d4ed8; 
            --text-general: #333;
            --quiz-option-bg: #f9f9f9;
            --quiz-option-border: #ccc;
            --quiz-option-hover-bg: #eef;
            --square-end-bg: #d1c4e9 !important; 
            --square-end-border: 3px solid #7e57c2 !important;
        }

        body.dark-mode {
            --bg-primary: #1a202c; 
            --bg-gradient-start: #2d3748; 
            --bg-gradient-end: #171923; 
            --bg-radial-dot: rgba(74, 85, 104, 0.3); 
            --game-wrapper-bg: rgba(45, 55, 72, 0.97); 
            --game-wrapper-shadow: 0 15px 45px rgba(0,0,0,0.4), 0 0 0 6px rgba(76, 175, 80, 0.25);
            --board-border-color: #4CAF50; 
            --board-border-color-rgb: 76, 175, 80;
            --board-path-bg: rgba(30, 46, 40, 0.8); 
            --board-path-bg-rgb: 30, 46, 40;
            --board-square-bg: #2d3748; 
            --board-square-shadow: 0 2px 5px rgba(0,0,0,0.2);
            --board-center-bg: rgba(26, 32, 44, 0.97); 
            --board-center-shadow: 0 8px 20px rgba(0,0,0,0.3);
            --popup-bg: #2d3748; 
            --popup-text-color: #f8f8f8;
            --input-bg: #4a5568; 
            --input-border: #718096; 
            --input-focus-border: var(--accent-color-2); 
            --player-info-box-bg: #4a5568;
            --player-info-box-border: #718096;
            --player-info-box-active-bg: #2c7a51; 
            --game-message-bg: #2c5242; 
            --game-message-bg-rgb: 44, 82, 66;
            --game-message-border: #38a169; 
            --game-message-text: #c6f6d5; 
            --footer-bg: rgba(26, 32, 44, 0.7);
            --footer-border-top: rgba(76, 175, 80, 0.4);
            --footer-text: #a0aec0; 
            --text-dark: #f8f8f8; 
            --text-heading-color: #68d391; 
            --text-subheading-color: #9ae6b4; 
            --text-quiz-title-color: #90cdf4; 
            --text-general: #f8f8f8;
            --quiz-option-bg: #4a5568;
            --quiz-option-border: #718096;
            --quiz-option-hover-bg: #2c7a51;
            --square-end-bg: #512da8 !important; 
            --square-end-border: 3px solid #9575cd !important;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-primary);
            background-image: linear-gradient(to bottom right, var(--bg-gradient-start), var(--bg-gradient-end)), 
                              radial-gradient(var(--bg-radial-dot) 1.2px, transparent 1.2px);
            background-size: cover, 28px 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 100vh;
            padding: 1rem;
            margin: 0;
            color: var(--text-general);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .game-wrapper {
            max-width: 900px;
            width: 100%;
            background-color: var(--game-wrapper-bg);
            border-radius: 20px;
            box-shadow: var(--game-wrapper-shadow);
            padding: clamp(1rem, 2.5vw, 1.2rem);
            border: 4px solid var(--board-border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: auto;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        
        #board-path-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--board-gap);
            justify-content: center;
            padding: var(--board-gap);
            background-color: var(--board-path-bg);
            border-radius: 12px;
            margin-bottom: 1rem; 
            position: relative; /* Crucial for absolute positioning of children */
            width: 100%;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease;
        }

        .board-square {
            width: var(--square-size);
            height: var(--square-size);
            border: 2px solid var(--board-border-color);
            background-color: var(--board-square-bg);
            transition: all 0.3s ease-in-out, transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 5px;
            overflow: hidden;
            position: relative;
            cursor: default;
            border-radius: 10px;
            box-shadow: var(--board-square-shadow);
            color: var(--text-general);
        }
        .board-square:hover:not(.highlight) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 5px 12px rgba(0,0,0,0.12);
        }
        body.dark-mode .board-square:hover:not(.highlight) {
            box-shadow: 0 5px 12px rgba(255,255,255,0.08);
        }
        
        .board-square.highlight {
            box-shadow: 0 0 20px 8px rgba(255, 215, 0, 0.9);
            transform: scale(1.05);
            z-index: 10;
            border-color: var(--accent-color-2);
        }

        .square-chance { background-color: #e0f7fa !important; border: 3px dashed #00BCD4 !important; border-radius: 25px !important; }
        .square-chance .location-icon i { color: #0097A7; }
        body.dark-mode .square-chance { background-color: #1e606d !important; border-color: #4dd0e1 !important; }
        body.dark-mode .square-chance .location-icon i { color: #80deea; }

        .square-fate { background-color: #fff3e0 !important; border: 3px dotted #FF9800 !important; border-radius: 50% !important; }
        .square-fate .location-icon i { color: #F57C00; }
        body.dark-mode .square-fate { background-color: #734000 !important; border-color: #ffb74d !important; }
        body.dark-mode .square-fate .location-icon i { color: #ffcc80; }

        .square-rest { background-color: #fce4ec !important; border: 3px double #E91E63 !important; border-radius: 12px 38px !important; }
        .square-rest .location-icon i { color: #C2185B; }
        body.dark-mode .square-rest { background-color: #6d0f2b !important; border-color: #f06292 !important; }
        body.dark-mode .square-rest .location-icon i { color: #f48fb1; }

        .square-end { 
            background-color: var(--square-end-bg) !important; 
            border: var(--square-end-border) !important;
            border-radius: 50% !important; 
        }
        .square-end .location-icon i { color: #FFD700; }
        .square-end .location-text { font-weight: bold; color: #6a0dad; }
        body.dark-mode .square-end .location-text { color: #ce93d8; }

        .square-fate .location-text, .square-chance .location-text {
             font-size: clamp(7px, 1.3vw, 9px);
        }
        
        /* Player token styling */
        .player {
            width: clamp(16px, 2.2vw, 20px); /* Slightly smaller token for better fit */
            height: clamp(16px, 2.2vw, 20px);
            border-radius: 50%;
            position: absolute; /* Positioned relative to #board-path-container */
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            z-index: 5;
            display: flex; /* Changed from none to flex for visibility */
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            font-size: clamp(8px, 1.3vw, 10px);
            border: 1px solid rgba(0,0,0,0.5);
        }

        #board-center {
            background-color: var(--board-center-bg);
            border-radius: 18px;
            display: flex;
            flex-direction: column; 
            align-items: center;
            padding: clamp(10px, 1.8vw, 15px); 
            box-shadow: var(--board-center-shadow);
            width: 100%;
            max-width: 900px; 
            border: 3px solid var(--board-border-color);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }

        .controls-top-bar {
            display: flex;
            flex-wrap: wrap; 
            align-items: center; 
            justify-content: space-around; 
            gap: 0.5rem 1rem; 
            width: 100%;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem; /* Add padding instead of border for visual separation */
            /* border-bottom: 1px solid rgba(var(--board-border-color-rgb), 0.2); */
        }
       /* body.dark-mode .controls-top-bar {
            border-bottom: 1px solid rgba(var(--board-border-color-rgb), 0.3);
        }*/


        .game-title-container {
            font-size: clamp(1rem, 1.8vw, 1.1rem); /* Slightly smaller title for the bar */
            font-weight: bold;
            color: var(--text-subheading-color);
            text-align: center;
            flex-shrink: 0; 
            margin-right: auto; /* Push other items to the right if space allows */
        }
        
        .game-setup-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .game-setup-controls label {
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            margin-right: 0.2rem;
            color: var(--text-general);
        }
        .game-setup-controls select {
            padding: 0.15rem 0.3rem;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-general);
            border: 1px solid var(--input-border);
        }
        .game-setup-controls .action-button {
            padding: 0.25rem 0.5rem;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
        }

        .current-player-turn-info {
            display: flex;
            align-items: center;
            gap: 0.3rem 0.6rem; 
            flex-wrap: nowrap; /* Try to keep on one line */
            justify-content: center;
            text-align: center;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            flex-shrink: 0;
            color: var(--text-general);
        }
        .current-player-turn-info > div { 
            display: flex;
            align-items: center;
            white-space: nowrap; /* Prevent text from wrapping within a single info item */
        }
        .current-player-turn-info .font-medium { margin-right: 0.2rem;}
        #current-player-name-display, #current-player-indicator { 
            color: var(--accent-color-1); 
            font-weight: bold;
        }
        body.dark-mode #current-player-name-display, body.dark-mode #current-player-indicator { 
            color: var(--accent-color-2); 
        }

        .dice-container {
            flex-shrink: 0; 
        }
        .dice {
            width: clamp(45px, 6vw, 50px);  /* Smaller dice */
            height: clamp(45px, 6vw, 50px);
            font-size: clamp(22px, 3.5vw, 28px);
            border-radius: 8px;
            background-color: var(--accent-color-1);
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease-out;
        }
        .dice:hover { transform: translateY(-2px) scale(1.1); box-shadow: 0 5px 10px rgba(0,0,0,0.25); }
        .dice:active { transform: translateY(0px) scale(1.03); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .dice.rolling { animation: diceRoll 0.5s ease-in-out infinite; }
        @keyframes diceRoll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(15deg) scale(1.05); }
            75% { transform: rotate(-15deg) scale(1.05); }
            100% { transform: rotate(0deg) scale(1); }
        }
        
        #player-name-setup { 
            width: 100%; 
            max-width: 500px; 
            margin: 0.5rem auto; 
            padding: 0.5rem;
            border: 1px solid rgba(var(--board-border-color-rgb), 0.15);
            border-radius: 8px;
            background-color: rgba(var(--board-path-bg-rgb), 0.2);
        }
        body.dark-mode #player-name-setup {
            border-color: rgba(var(--board-border-color-rgb), 0.25);
            background-color: rgba(var(--board-path-bg-rgb), 0.4);
        }
        #player-name-setup h4 { color: var(--text-subheading-color); font-size: 0.9rem; text-align: center; margin-bottom: 0.5rem;}
        #player-name-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; }
        .player-name-entry { display: flex; align-items: center; gap: 6px; padding: 5px 7px; background-color: var(--input-bg); border-radius: 6px; border: 1px solid var(--input-border); }
        .player-name-input { flex-grow: 1; border: 1px solid var(--input-border); border-radius: 4px; padding: 4px 8px; font-size: 0.85rem; background-color: var(--input-bg); color: var(--text-general); }
        .player-name-input::placeholder { color: #aaa; }
        body.dark-mode .player-name-input::placeholder { color: #718096; }
        .player-name-input:focus { border-color: var(--input-focus-border); box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-1-rgb),.25); outline: none;}
        body.dark-mode .player-name-input:focus { box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-2-rgb),.25); }

        .player-controls { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); 
            gap: 8px; 
            width: 100%; 
            max-height: 120px; 
            overflow-y: auto; 
            padding: 8px; 
            background-color: rgba(var(--board-path-bg-rgb), 0.4); 
            border-radius: 8px;
            margin-bottom: 0.75rem; 
        }
        body.dark-mode .player-controls { 
            background-color: rgba(var(--board-path-bg-rgb), 0.6);
        }
        
        .player-color-indicator { width: 14px; height: 14px; border-radius: 50%; display: inline-block; margin-right: 6px; border: 1px solid rgba(0,0,0,0.15); flex-shrink: 0;}
        .player-info-box { background-color: var(--player-info-box-bg); padding: 5px 7px; border-radius: 6px; font-size: clamp(10.5px, 1.7vw, 11.5px); border: 1.5px solid var(--player-info-box-border); transition: all 0.3s ease; color: var(--text-general); }
        .player-info-box .font-bold { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; /* Adjust as needed */}
        .player-info-box.active { border: 2.5px solid var(--accent-color-1); box-shadow: 0 0 8px rgba(var(--accent-color-1-rgb), 0.5); transform: scale(1.03); background-color: var(--player-info-box-active-bg); }
        body.dark-mode .player-info-box.active { box-shadow: 0 0 8px rgba(var(--accent-color-1-rgb), 0.7); }

        .game-message-area { background-color: var(--game-message-bg); padding: clamp(8px, 1.5vw, 10px); border-radius: 10px; width: 100%; text-align: center; color: var(--game-message-text); border: 1.5px solid var(--game-message-border); font-weight: 500; font-size: clamp(12px, 2vw, 14px); min-height: 40px; transition: opacity 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; margin-top: auto; }
        
        @media (max-width: 720px) { /* Adjust breakpoint for when top bar items stack more */
            .controls-top-bar {
                justify-content: center; 
            }
            .game-title-container { margin-right: 0; margin-bottom: 0.3rem; width: 100%;}
            .game-setup-controls, .current-player-turn-info, .dice-container {
                /* width: 100%; Allow them to take natural width and wrap */
                justify-content: center;
                margin-bottom: 0.3rem;
            }
        }
         @media (max-width: 480px) {
            .game-setup-controls {
                 flex-direction: column; 
                 gap: 0.3rem;
            }
            .current-player-turn-info {
                flex-direction: column;
                gap: 0.1rem;
            }
        }


        .popup-card {
            position: fixed;
            width: clamp(300px, 85vw, 400px);
            min-height: 180px;
            background-color: var(--popup-bg);
            color: var(--popup-text-color); 
            border-radius: 15px;
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
            padding: 25px 30px;
            z-index: 200;
            top: 50%; left: 50%;
            border: 4px solid var(--accent-color-1);
            display: flex; 
            flex-direction: column;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.85);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, background-color 0.3s ease, color 0.3s ease;
            pointer-events: none;
        }
        .popup-card.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }
         .popup-card h3 { color: var(--text-subheading-color); }
        #quiz-card #quiz-title { color: var(--text-quiz-title-color); }


        .quiz-options button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            margin-bottom: 10px;
            border: 1.5px solid var(--quiz-option-border);
            border-radius: 8px;
            background-color: var(--quiz-option-bg);
            color: var(--text-general);
            transition: background-color 0.2s, border-color 0.2s;
            font-size: 0.9rem;
        }
        .quiz-options button:hover { background-color: var(--quiz-option-hover-bg); border-color: var(--accent-color-1); }
        .quiz-options button:disabled { background-color: #777; opacity: 0.7; color: #bbb; cursor: not-allowed; }
        body.dark-mode .quiz-options button:disabled { background-color: #555; color: #888; }
        
        .location-icon i { font-size: clamp(24px, 3.8vw, 30px); margin-bottom: 5px; color: #388E3C; }
        body.dark-mode .location-icon i { color: #9ae6b4; } 
        .location-text { font-size: clamp(8.5px, 1.6vw, 10.5px); font-weight: 500; line-height: 1.25; }
        
        .action-button { 
            background-color: var(--accent-color-1);
            color: var(--text-light);
            padding: 7px 14px; 
            border-radius: 6px;
            font-size: 0.9rem; 
            transition: background-color 0.2s, transform 0.15s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border: none;
            cursor: pointer;
        }
        .action-button:hover { background-color: #388E3C; filter: brightness(110%); transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .action-button:active { transform: translateY(0px); filter: brightness(95%); box-shadow: 0 1px 2px rgba(0,0,0,0.15) inset; }
        .action-button:disabled { background-color: #aaa; cursor: not-allowed; filter: grayscale(50%);}
        body.dark-mode .action-button:disabled { background-color: #555; }
        
        .footer {
            width: 100%;
            text-align: center;
            padding: 15px 0;
            font-size: 0.85rem;
            color: var(--footer-text);
            margin-top: 30px;
            background-color: var(--footer-bg);
            border-top: 1px solid var(--footer-border-top);
            font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease, border-top-color 0.3s ease;
        }

        #theme-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: var(--accent-color-1);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        body.dark-mode #theme-toggle {
            background-color: var(--accent-color-2);
            color: var(--text-dark);
        }
        .game-wrapper h1 { color: var(--text-heading-color); }

    </style>
</head>
<body>
    <button id="theme-toggle" title="切換色彩模式">
        <i class="fas fa-sun"></i>
    </button>

    <div class="game-wrapper">
        <h1 class="text-2xl md:text-3xl font-bold text-center mb-4">漫遊雙溪步佈走讀神</h1>
        
        <div id="board-path-container">
            <!-- Start -->
            <div class="board-square" data-type="start" data-location="頂雙溪">
                <div class="location-icon"><i class="fas fa-flag-checkered"></i></div><div class="location-text">頂雙溪</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="雙溪火車站">
                <div class="location-icon"><i class="fas fa-train-subway"></i></div><div class="location-text">雙溪火車站</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="雙溪逐雨巷">
                <div class="location-icon"><i class="fas fa-cloud-showers-heavy"></i></div><div class="location-text">雙溪逐雨巷</div>
            </div>
            <div class="board-square square-fate" data-type="fate" data-location="平林溪">
                <div class="location-icon"><i class="fas fa-water"></i></div><div class="location-text">平林溪</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="雙溪打鐵舖">
                <div class="location-icon"><i class="fas fa-hammer"></i></div><div class="location-text">雙溪打鐵舖</div>
            </div>
            <div class="board-square square-rest" data-type="rest" data-location="海山餅店">
                <div class="location-icon"><i class="fas fa-cookie-bite"></i></div><div class="location-text">海山餅店</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="保我黎民碑">
                <div class="location-icon"><i class="fas fa-monument"></i></div><div class="location-text">保我黎民碑</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="雙溪三忠廟">
                <div class="location-icon"><i class="fas fa-landmark"></i></div><div class="location-text">雙溪三忠廟</div>
            </div>
            <div class="board-square square-chance" data-type="chance" data-location="毛蟹">
                <div class="location-icon"><i class="fas fa-paw"></i></div><div class="location-text">毛蟹</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="林益和堂">
                <div class="location-icon"><i class="fas fa-store"></i></div><div class="location-text">林益和堂</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="渡船頭">
                <div class="location-icon"><i class="fas fa-anchor"></i></div><div class="location-text">渡船頭</div>
            </div>
            <div class="board-square square-rest" data-type="rest" data-location="蔡冰雪花冰">
                <div class="location-icon"><i class="fas fa-ice-cream"></i></div><div class="location-text">蔡冰雪花冰</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="周家古厝">
                <div class="location-icon"><i class="fas fa-house-chimney-user"></i></div><div class="location-text">周家古厝</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="長安老街">
                <div class="location-icon"><i class="fas fa-road"></i></div><div class="location-text">長安老街</div>
            </div>
            <div class="board-square square-chance" data-type="chance" data-location="山藥">
                <div class="location-icon"><i class="fas fa-carrot"></i></div><div class="location-text">山藥</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="連舉人厝">
                <div class="location-icon"><i class="fas fa-landmark-dome"></i></div><div class="location-text">連舉人厝</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="蔴竹坑福德祠">
                <div class="location-icon"><i class="fas fa-place-of-worship"></i></div><div class="location-text">蔴竹坑福德祠</div>
            </div>
            <div class="board-square square-fate" data-type="fate" data-location="牡丹溪">
                <div class="location-icon"><i class="fas fa-water"></i></div><div class="location-text">牡丹溪</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="淡蘭古道">
                <div class="location-icon"><i class="fas fa-hiking"></i></div><div class="location-text">淡蘭古道</div>
            </div>
            <div class="board-square square-rest" data-type="rest" data-location="毛蟹盛">
                <div class="location-icon"><i class="fas fa-utensils"></i></div><div class="location-text">毛蟹盛</div>
            </div>
            <div class="board-square square-chance" data-type="chance" data-location="野薑花">
                <div class="location-icon"><i class="fas fa-fan"></i></div><div class="location-text">野薑花</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="虎豹潭">
                <div class="location-icon"><i class="fas fa-swimmer"></i></div><div class="location-text">虎豹潭</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="不厭亭">
                <div class="location-icon"><i class="fas fa-binoculars"></i></div><div class="location-text">不厭亭</div>
            </div>
            <div class="board-square" data-type="attraction" data-location="雙溪荷花園">
                <div class="location-icon"><i class="fas fa-spa"></i></div><div class="location-text">雙溪荷花園</div>
            </div>
            <!-- End -->
            <div class="board-square square-end" data-type="end" data-location="雙溪高中">
                <div class="location-icon"><i class="fas fa-trophy"></i></div><div class="location-text">雙溪高中</div>
            </div>
        </div> 
        
        <div id="board-center">
            <div class="controls-top-bar">
                <div class="game-title-container">遊戲控制板</div>
                <div class="game-setup-controls">
                    <div>
                        <label for="player-count">人數:</label>
                        <select id="player-count">
                            <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <button id="start-game" class="action-button">開始遊戲</button>
                </div>
                <div class="current-player-turn-info">
                    <div>
                        <span class="font-medium">輪到:</span>
                        <span id="current-player-name-display"></span>
                    </div>
                    <div>
                        <span class="font-medium">玩家:</span>
                        <span id="current-player-indicator"></span>
                    </div>
                </div>
                <div class="dice-container">
                    <div class="dice" id="dice"><i class="fas fa-dice-d6"></i></div>
                </div>
            </div>
            
            <div id="player-name-setup" style="display: none;"> <!-- Initially hidden, shown by JS -->
                 <h4 class="font-semibold mb-1.5 text-sm">設定玩家名稱 (選填):</h4>
                 <div id="player-name-inputs"></div>
            </div>

            <div class="player-controls" id="player-controls">
                <!-- Player info boxes will be generated here -->
            </div>

            <div class="game-message-area" id="game-message">選擇人數並開始遊戲！</div>
        </div>
        
        <!-- Event Card -->
        <div class="popup-card event-card" id="event-card">
            <h3 class="text-xl font-bold mb-3" id="event-title">事件卡</h3>
            <p id="event-description" class="mb-5 text-base flex-grow">事件描述</p>
            <button id="event-close" class="action-button w-full py-2.5">確定</button>
        </div>

        <!-- Quiz Card -->
        <div class="popup-card quiz-card" id="quiz-card">
            <h3 class="text-xl font-bold mb-3" id="quiz-title">景點問答</h3>
            <p id="quiz-question" class="mb-4 text-base font-medium">問題內容...</p>
            <div id="quiz-options" class="quiz-options mb-4 flex-grow">
                <!-- Options will be generated here -->
            </div>
            <p id="quiz-feedback" class="text-base font-bold mb-4 h-6 text-center"></p>
        </div>
    </div>

    <div class="footer">
        Copyright © Liyuchiutiger Gongminshen
    </div>

    <script>
        const el = (id) => document.getElementById(id);
        const diceElement = el('dice'), gameMessageElement = el('game-message'), playerCountSelect = el('player-count');
        const startGameButton = el('start-game'), currentPlayerIndicator = el('current-player-indicator');
        const currentPlayerNameDisplay = el('current-player-name-display');
        const playerControlsContainer = el('player-controls'), eventCardElement = el('event-card');
        const eventTitleElement = el('event-title'), eventDescriptionElement = el('event-description');
        const eventCloseButton = el('event-close'), boardPathContainer = el('board-path-container');
        const quizCardElement = el('quiz-card'), quizTitleElement = el('quiz-title');
        const quizQuestionElement = el('quiz-question'), quizOptionsElement = el('quiz-options');
        const quizFeedbackElement = el('quiz-feedback');
        const playerNameSetupDiv = el('player-name-setup'), playerNameInputsDiv = el('player-name-inputs');
        const themeToggleButton = el('theme-toggle');

        const CHANCE_OF_DOUBLING = 0.33;

        const gameState = {
            currentPlayer: 1, players: {}, playerCount: 2, diceRolling: false, boardPath: [], 
            gameStarted: false, currentQuiz: null, endSquareIndex: -1,
            playerColors: ['#E53935', '#1E88E5', '#43A047', '#FDD835', '#8E24AA', '#FB8C00', '#00ACC1', '#D81B60', '#6D4C41', '#7CB342', '#5E35B1', '#039BE5'],
            quizData: { 
                "雙溪火車站": [
                    { q: "雙溪火車站是宜蘭線上的其中一站，請問它的前一站與後一站分別是？", o: ["牡丹/貢寮", "瑞芳/福隆", "侯硐/三貂嶺", "十分/平溪"], a: 0 },
                    { q: "在雙溪火車站月台上，可以看到介紹當地何種特色生物的看板？", o: ["臺灣藍鵲", "毛蟹", "螢火蟲", "臺灣獼猴"], a: 1 },
                    { q: "下列何者不是雙溪火車站週邊可以租借到的交通工具？", o: ["電動自行車", "腳踏車", "YouBike", "汽車"], a: 3 }
                ],
                "雙溪逐雨巷": [
                    { q: "「雙溪逐雨巷」的石板路面設計，主要目的是為了什麼？", o: ["美觀", "防滑", "快速排水", "方便馬車行走"], a: 2 },
                    { q: "逐雨巷串連了雙溪老街的哪兩個主要區域？", o: ["火車站與市場", "三忠廟與渡船頭", "長安街與太平路", "林益和堂與打鐵舖"], a: 1 },
                    { q: "漫步在逐雨巷時，最不可能感受到下列何種氛圍？", o: ["懷舊古樸", "寧靜清幽", "現代繁華", "細雨濛濛的詩意"], a: 2 }
                ],
                "雙溪打鐵舖": [
                    { q: "雙溪打鐵舖的歷史悠久，請問它大約創立於哪個時期？", o: ["清朝末年", "日治時期", "民國初期", "民國70年代"], a: 1 },
                    { q: "打鐵舖師傅製作農具時，主要使用的燃料是什麼？", o: ["木炭", "煤炭", "瓦斯", "電力"], a: 1 },
                    { q: "除了農具，雙溪打鐵舖也可能製作下列何種生活用品？", o: ["菜刀", "鐵鍋", "鐵窗", "以上皆是"], a: 0 } 
                ],
                "保我黎民碑": [
                    { q: "「保我黎民」碑的立碑者主要是為了感謝誰的貢獻？", o: ["當時的清朝官員", "地方仕紳", "開墾先民", "媽祖庇佑"], a: 0 },
                    { q: "此碑文的字體風格屬於下列何者？", o: ["楷書", "隸書", "行書", "草書"], a: 0 }, 
                    { q: "「保我黎民」碑的材質主要是？", o: ["砂岩", "花崗岩", "大理石", "青銅"], a: 0 }
                ],
                "雙溪三忠廟": [
                    { q: "雙溪三忠廟是台灣唯一主祀「三忠公」的廟宇，請問「三忠公」指的是哪三位歷史人物？", o: ["文天祥、陸秀夫、張世傑", "岳飛、關羽、張飛", "諸葛亮、劉備、趙雲", "包拯、狄青、寇準"], a: 0 },
                    { q: "三忠廟每年農曆九月會舉辦盛大的迎媽祖繞境活動，請問此傳統的意義為何？", o: ["祈求豐收", "驅逐瘟疫", "紀念三忠公渡海來台", "與鄰近廟宇交流"], a: 2 }, 
                    { q: "三忠廟的建築風格展現了台灣傳統廟宇的何種特色？", o: ["剪黏藝術", "交趾陶", "木雕石刻", "以上皆是"], a: 3 }
                ],
                "林益和堂": [
                    { q: "林益和堂中藥舖的創辦人林燦廷先生，除了經營藥舖外，還具備何種身份？", o: ["詩人", "畫家", "醫生", "地方官員"], a: 0 },
                    { q: "在過去交通不便的年代，林益和堂對雙溪居民的主要貢獻是什麼？", o: ["提供醫療諮詢與藥材", "販售日常用品", "作為訊息交流中心", "以上皆是"], a: 0 },
                    { q: "林益和堂的建築本身具有何種風格特色？", o: ["閩南式街屋", "日式木造", "巴洛克式洋樓", "現代簡約"], a: 0 }
                ],
                "渡船頭": [
                    { q: "雙溪的渡船頭是哪兩條溪流的匯集處，形成了重要的水運樞紐？", o: ["基隆河與大漢溪", "平林溪與牡丹溪", "新店溪與景美溪", "大甲溪與濁水溪"], a: 1 },
                    { q: "在陸路交通不發達的年代，渡船頭主要扮演何種角色？", o: ["貨物集散地", "人員往來渡口", "軍事要塞", "A與B皆是"], a: 3 }, 
                    { q: "如今的渡船頭雖已不復當年繁忙景象，但仍可見到何種景觀？", o: ["舊時碼頭遺跡", "介紹歷史的解說牌", "供遊客休憩的涼亭", "以上皆是"], a: 3 }
                ],
                 "周家古厝": [
                    { q: "雙溪周家古厝的建築格局，屬於台灣傳統民居中的哪一種形式？", o: ["三合院", "四合院", "一條龍", "單伸手"], a: 0 },
                    { q: "周家古厝的牆體除了紅磚，還使用了當地常見的何種石材？", o: ["砂岩", "花崗岩", "大理石", "頁岩"], a: 0 },
                    { q: "參觀周家古厝（外觀）時，可以觀察到其建築上重視何種傳統價值？", o: ["風水佈局", "家族倫理", "精緻雕刻工藝", "以上皆是"], a: 3 }
                ],
                "長安老街": [
                    { q: "雙溪長安老街早年因何種礦產的開採而興盛？", o: ["煤礦", "金礦", "硫磺", "石灰石"], a: 0 },
                    { q: "長安老街上的建築風格，融合了哪些時期的特色？", o: ["清代閩南式", "日治時期洋樓", "現代RC結構", "以上皆有部分保留或改建"], a: 3 },
                    { q: "下列何者不是在長安老街可能找到的傳統行業或店家類型？", o: ["米店", "布行", "中藥鋪", "大型連鎖速食店"], a: 3 }
                ],
                "連舉人厝": [
                    { q: "「連舉人」指的是清代哪位在雙溪地區獲得功名的人物？", o: ["連成璧", "連橫", "連震東", "連戰"], a: 0 },
                    { q: "連舉人厝正廳門楣上懸掛的「文魁」匾額，代表何種意義？", o: ["科舉考試中鄉試優等", "皇帝御賜", "家族堂號", "地方耆老祝賀"], a: 0 },
                    { q: "連舉人厝的建築特色，反映了當時大戶人家的何種生活樣貌？", o: ["重視教育與功名", "講究建材與格局", "家族聚居的傳統", "以上皆是"], a: 3 }
                ],
                "蔴竹坑福德祠": [
                    { q: "蔴竹坑福德祠主要供奉的神祇是土地公，請問土地公在民間信仰中主要掌管什麼？", o: ["地方平安與農作豐收", "姻緣與愛情", "考試順利與功名", "航海安全與漁獲"], a: 0 },
                    { q: "福德祠通常興建於何種地點，以庇佑鄉里？", o: ["村莊入口或出口處", "田邊或山腳下", "水源地附近", "以上皆有可能"], a: 3 },
                    { q: "信眾通常會準備哪些供品來祭拜土地公？", o: ["麻糬、花生、水果", "牲禮、金紙", "茶、酒", "以上皆是常見供品"], a: 3 }
                ],
                "淡蘭古道": [
                    { q: "淡蘭古道是清代時期連接台灣北部哪兩個重要地區的交通要道？", o: ["淡水廳與噶瑪蘭廳", "台北府與基隆港", "新竹與宜蘭", "桃園與花蓮"], a: 0 },
                    { q: "淡蘭古道系統中，雙溪地區主要屬於哪一段路徑？", o: ["中路 (暖暖-宜蘭)", "北路 (瑞芳-大里)", "南路 (深坑-礁溪)", "以上皆非"], a: 0 }, 
                    { q: "行走在淡蘭古道的雙溪段，最能體驗到何種自然與人文景觀？", o: ["茂密森林與古樸石階", "梯田風光與茶園", "海岸峭壁與漁村", "現代化公路與隧道"], a: 0 }
                ],
                "虎豹潭": [
                    { q: "虎豹潭的地名由來，最廣為流傳的說法是因潭邊有兩座什麼形狀的巨岩？", o: ["老虎與豹", "龍與鳳", "烏龜與蛇", "獅子與大象"], a: 0 },
                    { q: "虎豹潭風景區以何種自然景觀最為著稱？", o: ["清澈溪流與壺穴地形", "高山湖泊與草原", "火山溫泉與硫磺噴氣孔", "沙灘海岸與珊瑚礁"], a: 0 },
                    { q: "前往虎豹潭進行戶外活動時，應特別注意下列何者以確保安全？", o: ["天氣變化與溪水暴漲", "野生動物攻擊", "迷路方向", "以上皆是"], a: 3 }
                ],
                "不厭亭": [
                    { q: "不厭亭位於哪兩條知名公路的交會點附近，成為單車族與攝影愛好者的熱門景點？", o: ["102縣道與瑞雙公路(北37)", "台2線濱海公路與台9線北宜公路", "國道一號與國道三號", "陽金公路與巴拉卡公路"], a: 0 },
                    { q: "「不厭亭」的名稱由來，據傳是取自李白的詩句「相看兩不厭」，原句的下一句是什麼？", o: ["只有敬亭山", "唯有飲者留其名", "舉杯邀明月", "人生得意須盡歡"], a: 0 },
                    { q: "站在不厭亭上，最著名的景觀是眺望蜿蜒的公路，此景觀常被稱為什麼？", o: ["寂寞公路", "天堂路", "髮夾彎大道", "黃金公路"], a: 0 }
                ],
                "雙溪荷花園": [
                    { q: "雙溪荷花園（現多稱上林荷花園或雙溪賞荷區）的最佳賞花期通常在每年的幾月到幾月？", o: ["六月至八月", "三月至五月", "九月至十一月", "十二月至二月"], a: 0 },
                    { q: "除了荷花，雙溪的賞荷區附近通常還可以看到何種與荷花相似但葉片挺出水面的水生植物？", o: ["蓮花", "睡蓮", "布袋蓮", "香蒲"], a: 0 }, 
                    { q: "欣賞荷花時，哪個時段通常花朵開得最美，也較涼爽？", o: ["清晨至上午", "正午時分", "下午時分", "傍晚黃昏"], a: 0 }
                ]
            }
        };
        const DICE_ICONS = ["fa-dice-d6", "fa-dice-one", "fa-dice-two", "fa-dice-three", "fa-dice-four", "fa-dice-five", "fa-dice-six"];
        let audioCtx;

        const produceEvents = [ 
            { title: '毛蟹大豐收', d: '毛蟹豐收，販售獲利 # 金幣', m: 250 }, 
            { title: '山藥田幫手酬勞', d: '協助收成山藥，獲報酬 # 金幣', m: 180 }, 
            { title: '野薑花季代言', d: '擔任推廣大使，獲代言費 # 金幣', m: 120 }, 
            { title: '作物蟲害損失', d: '作物遭遇蟲害，損失 # 金幣', m: -100 },
            { title: '特產行銷成功獎', d: '成功行銷特產，獲獎金 # 金幣', m: 200 }, 
            { title: '農具損壞維修', d: '農具損壞，修理花費 # 金幣', m: -90 }
        ];
        const streamEvents = [ 
            { title: '平林溪釣魚樂', d: '釣到大魚，獲 # 金幣', m: 200 }, 
            { title: '淨溪活動獎勵', d: '參加淨溪，獲環保獎 # 金幣', m: 150 }, 
            { title: '牡丹溪畔好心情', d: '踏青愉快，獲 # 金幣', m: 100 }, 
            { title: '溪水突漲損失', d: '裝備被沖走，損 # 金幣', m: -120 }, 
            { title: '遺失錢包', d: '遊玩不慎遺失錢包，損 # 金幣', m: -80 }, 
            { title: '發現秘境打卡', d: '拍照打卡獲社群獎 # 金幣', m: 180 }
        ];


        function getAudioContext() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("Web Audio API is not supported in this browser");
                    return null;
                }
            }
            return audioCtx;
        }

        function playSound(type) {
            const ctx = getAudioContext();
            if (!ctx) return;

            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            gainNode.gain.setValueAtTime(0.1, ctx.currentTime);

            if (type === 'correct') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); 
                oscillator.frequency.linearRampToValueAtTime(783.99, ctx.currentTime + 0.15); 
                gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.4);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.4);
            } else if (type === 'incorrect') {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(349.23, ctx.currentTime); 
                oscillator.frequency.linearRampToValueAtTime(261.63, ctx.currentTime + 0.2); 
                gainNode.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
            }
        }

        const updateGameMessage = (message) => {
            gameMessageElement.style.opacity = '0';
            setTimeout(() => {
                gameMessageElement.textContent = message;
                gameMessageElement.style.opacity = '1';
            }, 150);
        };

        const initBoardPath = () => {
            gameState.boardPath = [];
            const squareElements = boardPathContainer.querySelectorAll('.board-square');
            squareElements.forEach((el, index) => {
                const locationData = { 
                    element: el, 
                    name: el.dataset.location, 
                    type: el.dataset.type 
                };
                gameState.boardPath.push(locationData);
                if (locationData.type === 'end') {
                    gameState.endSquareIndex = index;
                }
            });
             // Initial positioning of tokens after board is ready, if any players exist (e.g. on reload)
            if (Object.keys(gameState.players).length > 0) {
                positionPlayers();
            }
        };
        
        const setupNameInputsUI = (count) => {
            playerNameInputsDiv.innerHTML = '';
            if (count > 0 && gameState.gameStarted === false) { 
                playerNameSetupDiv.style.display = 'block';
                for (let i = 1; i <= count; i++) {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'player-name-entry';

                    const colorIndicator = document.createElement('span');
                    colorIndicator.className = 'player-color-indicator';
                    colorIndicator.style.backgroundColor = gameState.playerColors[(i - 1) % gameState.playerColors.length];
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `player-name-input-${i}`;
                    input.placeholder = `玩家 ${i} 名稱`;
                    input.className = 'player-name-input';
                    
                    entryDiv.appendChild(colorIndicator);
                    entryDiv.appendChild(input);
                    playerNameInputsDiv.appendChild(entryDiv);
                }
            } else {
                playerNameSetupDiv.style.display = 'none';
            }
        };


        const initPlayers = (count) => {
            document.querySelectorAll('.player').forEach(p => p.remove());
            playerControlsContainer.innerHTML = ''; 
            gameState.players = {};
            for (let i = 1; i <= count; i++) {
                const nameInput = el(`player-name-input-${i}`);
                const playerName = nameInput && nameInput.value.trim() ? nameInput.value.trim() : `玩家 ${i}`;

                const playerToken = document.createElement('div');
                playerToken.id = `player${i}-token`;
                playerToken.className = 'player';
                playerToken.style.backgroundColor = gameState.playerColors[(i-1) % gameState.playerColors.length];
                playerToken.textContent = i;
                boardPathContainer.appendChild(playerToken);
                
                const playerInfoBox = document.createElement('div');
                playerInfoBox.id = `player${i}-infobox`;
                playerInfoBox.className = 'player-info-box';
                playerInfoBox.innerHTML = `<div class="flex items-center mb-0.5"><div class="player-color-indicator" style="background-color: ${gameState.playerColors[(i-1) % gameState.playerColors.length]}"></div><div class="font-bold">${playerName}</div></div><div>金幣: <span id="player${i}-money">1000</span></div>`;
                playerControlsContainer.appendChild(playerInfoBox);

                gameState.players[i] = { 
                    id: i, name: playerName, position: 0, money: 1000, 
                    color: gameState.playerColors[(i-1) % gameState.playerColors.length],
                    tokenElement: playerToken, infoBoxElement: playerInfoBox
                };
            }
            positionPlayers(); // Position them for the first time
            updateAllMoneyDisplays();
        };

        const positionPlayers = () => {
            Object.values(gameState.players).forEach((playerData) => {
                const playerToken = playerData.tokenElement;
                if (!playerToken) return; 

                const squareData = gameState.boardPath[playerData.position];
                if (!squareData || !squareData.element) {
                    playerToken.style.display = 'none';
                    return;
                }
                playerToken.style.display = 'flex'; 

                const squareElement = squareData.element;
                const squareRect = squareElement.getBoundingClientRect(); // More accurate than offsetWidth/Height

                // Get actual rendered size of the token
                // For this to work consistently, tokens must be visible (display != 'none') BEFORE calling getBoundingClientRect
                // If tokens are initially display:none, their rect will be all zeros.
                // So, ensure tokens are display:flex (or block) before this.
                // One way is to set it above or ensure initPlayers sets them to visible.
                let tokenWidth = parseFloat(getComputedStyle(playerToken).width);
                let tokenHeight = parseFloat(getComputedStyle(playerToken).height);
                // Fallback if getComputedStyle is zero (e.g. if element was hidden and just made visible)
                if(tokenWidth === 0 || tokenHeight === 0) {
                    const tempRect = playerToken.getBoundingClientRect();
                    tokenWidth = tempRect.width || clamp(16, 0.022 * window.innerWidth, 20); // Use clamp as fallback
                    tokenHeight = tempRect.height || clamp(16, 0.022 * window.innerWidth, 20);
                }


                const playersOnThisSquare = Object.values(gameState.players).filter(p => p.position === playerData.position);
                const playerIndexOnSquare = playersOnThisSquare.findIndex(p => p.id === playerData.id);

                let offsetX = 0;
                let offsetY = 0;
                const gap = 2; 

                if (playersOnThisSquare.length > 1) {
                    const itemsPerRow = Math.min(2, Math.ceil(Math.sqrt(playersOnThisSquare.length))); // Max 2 items per row for small tokens
                    const col = playerIndexOnSquare % itemsPerRow;
                    const row = Math.floor(playerIndexOnSquare / itemsPerRow);
                    
                    const numRows = Math.ceil(playersOnThisSquare.length / itemsPerRow);

                    const totalGridWidth = itemsPerRow * tokenWidth + (itemsPerRow - 1) * gap;
                    const totalGridHeight = numRows * tokenHeight + (numRows - 1) * gap;
                    
                    const gridBaseX = (squareRect.width - totalGridWidth) / 2;
                    const gridBaseY = (squareRect.height - totalGridHeight) / 2;

                    offsetX = gridBaseX + col * (tokenWidth + gap);
                    offsetY = gridBaseY + row * (tokenHeight + gap);

                } else { 
                    offsetX = (squareRect.width - tokenWidth) / 2;
                    offsetY = (squareRect.height - tokenHeight) / 2;
                }
                
                playerToken.style.left = `${squareElement.offsetLeft + offsetX}px`;
                playerToken.style.top = `${squareElement.offsetTop + offsetY}px`;
            });
        };

        function clamp(value, min, max) { return Math.min(Math.max(value, min), max); }

        const updatePlayerMoneyDisplay = (playerId) => {
            const moneyElement = el(`player${playerId}-money`);
            if (moneyElement && gameState.players[playerId]) moneyElement.textContent = gameState.players[playerId].money;
        };
        const updateAllMoneyDisplays = () => Object.keys(gameState.players).forEach(pId => updatePlayerMoneyDisplay(parseInt(pId)));

        const highlightCurrentPlayerInfoBox = () => {
            Object.values(gameState.players).forEach(player => {
                if (player.infoBoxElement) player.infoBoxElement.classList.remove('active');
            });
            if (gameState.players[gameState.currentPlayer] && gameState.players[gameState.currentPlayer].infoBoxElement) {
                 gameState.players[gameState.currentPlayer].infoBoxElement.classList.add('active');
            }
        };

        const rollDice = async () => {
            if (gameState.diceRolling || !gameState.gameStarted) return;
            gameState.diceRolling = true;
            diceElement.classList.add('rolling');
            diceElement.innerHTML = `<i class="fas fa-dice fa-spin"></i>`;
            
            const player = gameState.players[gameState.currentPlayer];
            updateGameMessage(`${player.name} 正在擲骰子...`);
            gameState.boardPath.forEach(pos => pos.element?.classList.remove('highlight'));

            await new Promise(resolve => setTimeout(resolve, 1200)); 

            const roll = Math.floor(Math.random() * 6) + 1;
            diceElement.classList.remove('rolling');
            diceElement.innerHTML = `<i class="fas ${DICE_ICONS[roll]}"></i>`;
            updateGameMessage(`${player.name} 擲出 ${roll}點...`);
            
            const startPosition = player.position;
            let hasWon = false;

            for (let i = 1; i <= roll; i++) {
                let currentStepPos = startPosition + i;
                if (currentStepPos >= gameState.endSquareIndex) {
                    player.position = gameState.endSquareIndex;
                    hasWon = true;
                } else {
                    player.position = currentStepPos % gameState.boardPath.length; 
                }
                positionPlayers();
                if (hasWon) {
                    await new Promise(resolve => setTimeout(resolve, 300)); 
                    break; 
                }
                await new Promise(resolve => setTimeout(resolve, 250)); 
            }
            
            const landedSquareData = gameState.boardPath[player.position];
            landedSquareData.element?.classList.add('highlight');

            if (hasWon) {
                handleWin();
            } else {
                updateGameMessage(`${player.name} 抵達 ${landedSquareData.name}`);
                setTimeout(() => handleSquareAction(landedSquareData), 800);
            }
        };
        
        function handleWin() {
            const player = gameState.players[gameState.currentPlayer];
            const endSquareData = gameState.boardPath[gameState.endSquareIndex];
            player.money += 300;
            updatePlayerMoneyDisplay(gameState.currentPlayer);
            updateGameMessage(`🎉 ${player.name} 抵達終點 ${endSquareData.name} 並獲勝！🎉`);

            diceElement.style.pointerEvents = 'none';
            diceElement.innerHTML = `<i class="fas fa-trophy"></i>`;
            gameState.gameStarted = false; 

            showEventCardWithCustomMessage(
                `🎉 恭喜 ${player.name}！ 🎉`,
                `你已成功抵達 ${endSquareData.name}，成為雙溪步佈走讀神！獲得 300 金幣獎勵！遊戲結束。`
            );
        }
        
        function handleSquareAction(squareData) {
            if (!gameState.gameStarted && squareData.type !== 'end') return;

            switch(squareData.type) {
                case 'chance': case 'fate':
                    showEvent(squareData.type); break;
                case 'rest': case 'start':
                    showRestEvent(squareData.name, squareData.type); break;
                case 'attraction':
                    showQuiz(squareData.name); break;
                case 'end': 
                    handleWin();
                    break;
                default:
                    setTimeout(nextPlayerTurn, 700); 
            }
        }
        
        function showEventCardWithCustomMessage(title, description) {
            eventTitleElement.textContent = title;
            eventDescriptionElement.textContent = description;
            showPopup(eventCardElement);
        }

        const nextPlayerTurn = () => {
            const previousPlayer = gameState.players[gameState.currentPlayer];
            if (previousPlayer && gameState.boardPath[previousPlayer.position]) {
                 gameState.boardPath[previousPlayer.position].element?.classList.remove('highlight');
            }

            if (!gameState.gameStarted) { 
                updateGameMessage('遊戲結束！請選擇人數並點擊「開始遊戲」重新開始。');
                startGameButton.disabled = false;
                playerCountSelect.disabled = false;
                setupNameInputsUI(parseInt(playerCountSelect.value)); 
                playerNameInputsDiv.querySelectorAll('input').forEach(input => input.value = '');
                diceElement.innerHTML = `<i class="fas fa-dice-d6"></i>`;
                diceElement.style.pointerEvents = 'auto';
                currentPlayerIndicator.textContent = "-";
                currentPlayerNameDisplay.textContent = "等待開始";
                return;
            }

            gameState.currentPlayer = (gameState.currentPlayer % gameState.playerCount) + 1;
            const currentPlayerData = gameState.players[gameState.currentPlayer];
            currentPlayerIndicator.textContent = currentPlayerData.id;
            currentPlayerNameDisplay.textContent = currentPlayerData.name;

            updateGameMessage(`輪到 ${currentPlayerData.name} 的回合`);
            gameState.diceRolling = false;
            diceElement.innerHTML = `<i class="fas fa-dice-d6"></i>`;
            highlightCurrentPlayerInfoBox();

            const currentPlayerSquare = gameState.boardPath[currentPlayerData.position];
            if (currentPlayerSquare && currentPlayerSquare.element) {
                currentPlayerSquare.element.classList.add('highlight');
            }
        };
        
        const showPopup = (element) => {
            element.style.display = 'flex'; 
            setTimeout(() => element.classList.add('visible'), 10);
        };

        const hidePopup = (element, callback) => {
            element.classList.remove('visible');
            setTimeout(() => {
                element.style.display = 'none';
                if (callback) callback();
            }, 300); 
        };

        const showEvent = (type) => {
            let events, titlePrefix;
            const isDoubled = Math.random() < CHANCE_OF_DOUBLING; 

            if (type === 'chance') { 
                titlePrefix = "機會";
                events = produceEvents;
            } else { 
                titlePrefix = "命運";
                events = streamEvents;
            }

            const randomEvent = {...events[Math.floor(Math.random() * events.length)]};
            let actualMoney = randomEvent.m;
            let titleSuffix = "";

            if (isDoubled && randomEvent.m !== 0) { 
                actualMoney *= 2; 
                titleSuffix = " (雙倍效果!)"; 
            }
            
            randomEvent.d = randomEvent.d.replace('#', Math.abs(actualMoney));
            eventTitleElement.textContent = `${titlePrefix}: ${randomEvent.title}${titleSuffix}`;
            eventDescriptionElement.textContent = randomEvent.d;
            
            const player = gameState.players[gameState.currentPlayer];
            player.money += actualMoney;
            updatePlayerMoneyDisplay(gameState.currentPlayer);
            
            let currentMsg = gameMessageElement.textContent;
            currentMsg += ` ${actualMoney >= 0 ? '獲得' : '損失'} ${Math.abs(actualMoney)} 金幣。`;
            updateGameMessage(currentMsg);

            showPopup(eventCardElement);
        };

        const showRestEvent = (locationName, type) => {
            if (type === 'start' && gameState.players[gameState.currentPlayer].position === 0 && 
                Object.values(gameState.players).some(p => p.position > 0 || Object.keys(gameState.players).length === 0)) {
                updateGameMessage(`${gameState.players[gameState.currentPlayer].name} 回到起點，休息一下。`);
                showEventCardWithCustomMessage("回到起點", `${locationName} - 稍作停留，養精蓄銳。`);
                return;
            }

            let eventData = { title: `${locationName} 休息一下`, description: `在 ${locationName} 稍作停留，養精蓄銳。`, money: 0 };
            let baseMoney = 0;
            let isMoneyRest = false;

            if (locationName === '海山餅店') { baseMoney = 100; eventData.title = '海山餅店小憩'; eventData.description = '品嚐香濃寒天布丁蛋糕，恢復元氣，獲 # 金幣。'; isMoneyRest = true;}
            else if (locationName === '蔡冰雪花冰') { baseMoney = 120; eventData.title = '蔡冰雪花冰透心涼'; eventData.description = '享用美味花生雪花冰，暑氣全消，獲 # 金幣。'; isMoneyRest = true;}
            else if (locationName === '毛蟹盛') { baseMoney = 150; eventData.title = '毛蟹盛宴'; eventData.description = '品嚐肥美毛蟹，精力充沛，獲 # 金幣。'; isMoneyRest = true;}
            
            let actualMoney = baseMoney;
            let titleSuffix = "";
            if (isMoneyRest && Math.random() < CHANCE_OF_DOUBLING) {
                actualMoney *= 2;
                titleSuffix = " (雙倍獎勵!)";
            }
            eventData.money = actualMoney;
            eventData.description = eventData.description.replace('#', actualMoney);
            
            eventTitleElement.textContent = eventData.title + titleSuffix;
            eventDescriptionElement.textContent = eventData.description;

            if (eventData.money > 0) { 
                gameState.players[gameState.currentPlayer].money += eventData.money; 
                updatePlayerMoneyDisplay(gameState.currentPlayer);
                let currentMsg = gameMessageElement.textContent;
                currentMsg += ` 獲得 ${eventData.money} 金幣。`;
                updateGameMessage(currentMsg);
            }
            showPopup(eventCardElement);
        };

        const showQuiz = (locationName) => {
            const quizzesForLocation = gameState.quizData[locationName];
            if (!quizzesForLocation || quizzesForLocation.length === 0) { 
                updateGameMessage(`抱歉，${locationName} 目前沒有問答題目。`);
                setTimeout(nextPlayerTurn, 1500); 
                return; 
            }
            
            const randomIndex = Math.floor(Math.random() * quizzesForLocation.length);
            const quiz = quizzesForLocation[randomIndex];

            gameState.currentQuiz = { ...quiz, location: locationName }; 
            quizTitleElement.textContent = `${locationName} 問答`;
            quizQuestionElement.textContent = quiz.q;
            quizOptionsElement.innerHTML = '';
            quiz.o.forEach((optionText, index) => {
                const button = document.createElement('button');
                button.textContent = `${String.fromCharCode(65 + index)}. ${optionText}`;
                button.dataset.index = index;
                button.addEventListener('click', handleQuizAnswer);
                quizOptionsElement.appendChild(button);
            });
            quizFeedbackElement.textContent = '';
            quizFeedbackElement.style.color = ''; 
            showPopup(quizCardElement);
        };

        function handleQuizAnswer(event) {
            const selectedIndex = parseInt(event.target.dataset.index);
            const quiz = gameState.currentQuiz;
            const player = gameState.players[gameState.currentPlayer];
            let feedback = "";
            let moneyChange = 0;

            if (selectedIndex === quiz.a) {
                playSound('correct');
                feedback = "答對了！真厲害！獲得 50 金幣！";
                moneyChange = 50;
                quizFeedbackElement.style.color = 'green';
            } else {
                playSound('incorrect');
                feedback = `答錯了，正確答案是 ${String.fromCharCode(65 + quiz.a)}. ${quiz.o[quiz.a]}。損失 20 金幣。`;
                moneyChange = -20;
                quizFeedbackElement.style.color = 'red';
            }
            player.money += moneyChange;
            updatePlayerMoneyDisplay(gameState.currentPlayer);
            quizFeedbackElement.textContent = feedback;
            
            quizOptionsElement.querySelectorAll('button').forEach(btn => btn.disabled = true);

            setTimeout(() => {
                hidePopup(quizCardElement, nextPlayerTurn);
            }, 2800); 
        }

        function setDarkTheme(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-moon"></i>';
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                themeToggleButton.innerHTML = '<i class="fas fa-sun"></i>';
                localStorage.setItem('theme', 'light');
            }
        }

        themeToggleButton.addEventListener('click', () => {
            setDarkTheme(!document.body.classList.contains('dark-mode'));
        });

        const preferredTheme = localStorage.getItem('theme');
        if (preferredTheme === 'dark') {
            setDarkTheme(true);
        } else if (preferredTheme === 'light') {
            setDarkTheme(false);
        } else { 
             setDarkTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
        }

        playerCountSelect.addEventListener('change', () => {
             if (!gameState.gameStarted) { 
                setupNameInputsUI(parseInt(playerCountSelect.value));
            }
        });

        startGameButton.addEventListener('click', () => {
            gameState.playerCount = parseInt(playerCountSelect.value);
            if (gameState.playerCount < 1 || gameState.playerCount > 12) { 
                updateGameMessage("請選擇 1 至 12 位玩家！");
                return;
            }
            initPlayers(gameState.playerCount);
            gameState.gameStarted = true;
            gameState.currentPlayer = 1; 
            
            const firstPlayer = gameState.players[1];
            currentPlayerIndicator.textContent = firstPlayer.id;
            currentPlayerNameDisplay.textContent = firstPlayer.name;
            
            updateGameMessage(`遊戲開始！輪到 ${firstPlayer.name}`);
            diceElement.innerHTML = `<i class="fas fa-dice-d6"></i>`;
            diceElement.style.pointerEvents = 'auto';
            highlightCurrentPlayerInfoBox();
            
            gameState.boardPath.forEach(pos => pos.element?.classList.remove('highlight'));
            gameState.boardPath[0]?.element?.classList.add('highlight'); 
            
            playerCountSelect.disabled = true; 
            startGameButton.disabled = true;
            playerNameSetupDiv.style.display = 'none'; 
        });

        diceElement.addEventListener('click', rollDice);
        
        eventCloseButton.addEventListener('click', () => {
            hidePopup(eventCardElement, nextPlayerTurn);
        });

        document.addEventListener('DOMContentLoaded', () => {
            initBoardPath(); 
            playerCountSelect.value = "2"; 
            setupNameInputsUI(2); 
            currentPlayerIndicator.textContent = "-";
            currentPlayerNameDisplay.textContent = "等待開始";
            updateGameMessage('選擇人數，輸入名稱(選填)，並點擊「開始遊戲」！');
            diceElement.style.pointerEvents = 'auto';
        });
        window.addEventListener('resize', () => { 
            if (gameState.gameStarted || Object.keys(gameState.players).length > 0) {
                positionPlayers(); 
            }
        });
    </script>
</body>
</html>